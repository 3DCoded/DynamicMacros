
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://3dcoded.github.io/DynamicMacros/extras/extras-ex3/">
      
      
        <link rel="prev" href="../extras-ex2/">
      
      
        <link rel="next" href="../../examples/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>Example 3: KlipperMaintenance - Klipper Dynamic Macros</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-1YVCJR4FQR"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-1YVCJR4FQR",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-1YVCJR4FQR",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#example-3-klippermaintenance" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Klipper Dynamic Macros" class="md-header__button md-logo" aria-label="Klipper Dynamic Macros" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Klipper Dynamic Macros
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Example 3: KlipperMaintenance
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/3dcoded/DynamicMacros" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Klipper Dynamic Macros" class="md-nav__button md-logo" aria-label="Klipper Dynamic Macros" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Klipper Dynamic Macros
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/3dcoded/DynamicMacros" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Table of Contents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/converting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Converting to Dynamic Macros
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/usingfeatures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Dynamic Macros Features
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/experimental/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Experimental Features
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Features
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/recursion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Recursion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/receivingvariables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving Variable Updates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/utilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utility Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/variables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Variables
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../features/delayed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Delayed GCode
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Klippy Extras
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Klippy Extras
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Start Writing Klippy Extras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras-ex1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example 1: Greeter (Structure)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras-ex2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example 2: BetterGreeter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Example 3: KlipperMaintenance
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Example 3: KlipperMaintenance
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#full-code" class="md-nav__link">
    <span class="md-ellipsis">
      Full Code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#structure" class="md-nav__link">
    <span class="md-ellipsis">
      Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintain-class" class="md-nav__link">
    <span class="md-ellipsis">
      Maintain class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Maintain class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializer" class="md-nav__link">
    <span class="md-ellipsis">
      Initializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance-class" class="md-nav__link">
    <span class="md-ellipsis">
      Maintenance Class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Maintenance Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializer_1" class="md-nav__link">
    <span class="md-ellipsis">
      Initializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feedback" class="md-nav__link">
    <span class="md-ellipsis">
      Feedback
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example Macros
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../devstatus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Status
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#full-code" class="md-nav__link">
    <span class="md-ellipsis">
      Full Code
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#structure" class="md-nav__link">
    <span class="md-ellipsis">
      Structure
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintain-class" class="md-nav__link">
    <span class="md-ellipsis">
      Maintain class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Maintain class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializer" class="md-nav__link">
    <span class="md-ellipsis">
      Initializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#maintenance-class" class="md-nav__link">
    <span class="md-ellipsis">
      Maintenance Class
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Maintenance Class">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#initializer_1" class="md-nav__link">
    <span class="md-ellipsis">
      Initializer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#feedback" class="md-nav__link">
    <span class="md-ellipsis">
      Feedback
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                


    <a href="../../print_page/" title="Print Site" class="md-content__button md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 3H6v4h12m1 5a1 1 0 0 1-1-1 1 1 0 0 1 1-1 1 1 0 0 1 1 1 1 1 0 0 1-1 1m-3 7H8v-5h8m3-6H5a3 3 0 0 0-3 3v6h4v4h12v-4h4v-6a3 3 0 0 0-3-3Z"/></svg>
    </a>



                  

  
    <a href="https://github.com/3dcoded/DynamicMacros/blob/docs/docs/extras/extras-ex3.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


<h1 id="example-3-klippermaintenance">Example 3: KlipperMaintenance</h1>
<p>This last example of the Klippy extra development tutorial is actually one of my other Klipper projects: <a href="https://github.com/3DCoded/KlipperMaintenance">KlipperMaintenance</a>, a maintenance reminder system for Klipper.</p>
<p>This example will go through how the KlipperMaintenance code works to teach a few more important things about developing Klippy extras.</p>
<h2 id="full-code">Full Code</h2>
<p>For this tutorial, we'll start with the full code, then break it down and explain what each section does. If you can learn to read existing Klippy extras, you can read the <a href="https://github.com/Klipper3d/klipper/tree/master/klippy/extras">builtin Klippy extras</a> when developing your own extras.</p>
<details class="quote" open="open">
<summary>Full Code</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">  1</a></span>
<span class="normal"><a href="#__codelineno-0-2">  2</a></span>
<span class="normal"><a href="#__codelineno-0-3">  3</a></span>
<span class="normal"><a href="#__codelineno-0-4">  4</a></span>
<span class="normal"><a href="#__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span> <span class="nn">urllib.request</span> <span class="k">as</span> <span class="nn">requests</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">API_URL</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:7125/server/history/totals&#39;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="n">HOME_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span><span class="s2">&quot;klippy:ready&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_ready</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span><span class="s1">&#39;MAINTAIN_STATUS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS_help</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">def</span> <span class="nf">_handle_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gcode_timer_event</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="k">def</span> <span class="nf">_gcode_timer_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="p">):</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_maintenance</span><span class="p">()</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">nextwake</span> <span class="o">=</span> <span class="n">eventtime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">return</span> <span class="n">nextwake</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="k">def</span> <span class="nf">check_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>                <span class="k">continue</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">run_script_from_command</span><span class="p">(</span><span class="s1">&#39;M117 Maintenance Expired!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">cmd_MAINTAIN_STATUS_help</span> <span class="o">=</span> <span class="s1">&#39;Check status of maintenance&#39;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">def</span> <span class="nf">cmd_MAINTAIN_STATUS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="k">continue</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="n">remain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="k">if</span> <span class="n">remain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="n">obj</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1"> remaining&#39;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">(</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;print_time&#39;</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;print_time&#39;</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="c1"># register GCode commands</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;CHECK_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE_help</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;UPDATE_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE_help</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">def</span> <span class="nf">fetch_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">API_URL</span><span class="p">)</span> <span class="c1"># fetch data from Moonraker History API</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="p">}</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">job_totals</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;job_totals&#39;</span><span class="p">]</span> <span class="c1"># get job totals from JSON response</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_filament_used&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="p">}</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">def</span> <span class="nf">fetch_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">def</span> <span class="nf">update_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">def</span> <span class="nf">get_remaining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">cmd_CHECK_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Check maintenance&#39;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">def</span> <span class="nf">cmd_CHECK_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">gcmd</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="s1">Maintenance </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> Status:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="s1">Next maintenance in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="si">}</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="s1">Maintenance message: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">cmd_UPDATE_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Update maintenance&#39;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="k">def</span> <span class="nf">cmd_UPDATE_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">())</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">return</span> <span class="n">Maintenance</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="k">def</span> <span class="nf">load_config_prefix</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">return</span> <span class="n">Maintain</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="structure">Structure</h2>
<p>The class structure of this Klippy extra is shown in this flowchart:</p>
<pre class="mermaid"><code>classDiagram
    class Maintain{
        str name
        str label
        str trigger
        int threshold
        str message
        fetch_history()
        init_db()
        fetch_db()
        update_db(new)
        get_remaining()
        cmd_CHECK_MAINTENANCE(gcmd)
        cmd_UPDATE_MAINTENANCE(gcmd)
    }
    note for Maintain "trigger must be one of:\n - print_time\n - filament\n - time"

    class Maintenance{
        int interval
        _handle_ready()
        _gcode_timer_event()
        check_maintenance()
        cmd_MAINTAIN_STATUS(gcmd)
    }

    Maintenance &lt;|-- Maintain: Has-a</code></pre>
<p>This diagram has a lot of information, but the key points are:</p>
<ul>
<li>Multiple <code>Maintain</code> objects are managed by one <code>Maintainence</code> object.</li>
<li>The <code>Maintain</code> class handles maintenance reminders, the <code>CHECK_MAINTENANCE</code> command, and the <code>UPDATE_MAINTENANCE</code> command.</li>
<li>The <code>Maintenance</code> class handles the <code>MAINTAIN_STATUS</code> command.</li>
<li>A <code>[maintain name]</code> section corresponds to the <code>Maintain</code> class (multiple).</li>
<li>A <code>[maintain]</code> section corresponds to the <code>Maintenance</code> class (one).</li>
</ul>
<p>The base code for this is:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span>
<span class="normal"><a href="#__codelineno-1-17">17</a></span>
<span class="normal"><a href="#__codelineno-1-18">18</a></span>
<span class="normal"><a href="#__codelineno-1-19">19</a></span>
<span class="normal"><a href="#__codelineno-1-20">20</a></span>
<span class="normal"><a href="#__codelineno-1-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span> <span class="nn">urllib.request</span> <span class="k">as</span> <span class="nn">requests</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="n">API_URL</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:7125/server/history/totals&#39;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="n">HOME_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="hll"><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
</span><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="hll">    <span class="k">pass</span>
</span><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="hll">
</span><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="hll"><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
</span><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="hll">    <span class="k">pass</span>
</span><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="hll">
</span><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="hll"><span class="c1"># (1)!</span>
</span><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="hll"><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
</span><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="hll">    <span class="k">return</span> <span class="n">Maintenance</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="hll">
</span><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="hll"><span class="c1"># (2)!</span>
</span><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="k">def</span> <span class="nf">load_config_prefix</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>    <span class="k">return</span> <span class="n">Maintain</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>This function corresponds to a <code>[maintain]</code> config section.</li>
<li>This function corresponds to a <code>[maintain name]</code> config section.</li>
</ol>
<p>The highlighted section in the code contains the classes, and the configuration loading, the parts relevant to this first section. The code above the highlighted section includes the relevant module imports and constant declarations (both explained later).</p>
<p class="annotate">Much of the content in this example will be embedded in the code (usually the highlighted section) as a plus sign, like this: (1)</p>
<ol>
<li>Click some more plus marks in the code to learn more about the code.</li>
</ol>
<h2 id="maintain-class"><code>Maintain</code> class</h2>
<p>This next section of the example will focus on the <code>Maintain</code> class.</p>
<h3 id="initializer">Initializer</h3>
<p>When <code>load_config_prefix</code> creates a <code>Maintain</code> object, it starts in the initializer. </p>
<p>Here's the full initializer, with explanations embedded inside with plus signs. Below is a more general breakdown of the initializer for clarity.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span>
<span class="normal"><a href="#__codelineno-2-22">22</a></span>
<span class="normal"><a href="#__codelineno-2-23">23</a></span>
<span class="normal"><a href="#__codelineno-2-24">24</a></span>
<span class="normal"><a href="#__codelineno-2-25">25</a></span>
<span class="normal"><a href="#__codelineno-2-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
</span><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (1)!</span>
</span><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="hll">
</span><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="hll">        <span class="c1"># (2)!</span>
</span><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">(</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;print_time&#39;</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span> 
</span><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="hll">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="c1"># (3)!</span>
</span><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
</span><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="hll">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span>
</span><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
</span><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="hll">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
</span><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
</span><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="hll">
</span><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-21" name="__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>        <span class="c1"># (4)!</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;CHECK_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE_help</span><span class="p">)</span>
</span><a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;UPDATE_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE_help</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li><code class="highlight"><span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span></code> returns the full config name, like <code class="highlight"><span class="s2">&quot;maintain name&quot;</span></code>. The <code class="highlight"><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span></code> splits the name by spaces and gets the last "word".</li>
<li><code class="highlight"><span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">()</span></code> allows you to only accept values in a certain list.</li>
<li>This part of the initializer chooses the units based on the <code>trigger</code> type:<ul>
<li><code class="highlight"><span class="s2">&quot;print_time&quot;</span></code>: <code class="highlight"><span class="s2">&quot;h&quot;</span></code></li>
<li><code class="highlight"><span class="s2">&quot;filament&quot;</span></code>: <code class="highlight"><span class="s2">&quot;m&quot;</span></code></li>
<li><code class="highlight"><span class="s2">&quot;time&quot;</span></code>: <code class="highlight"><span class="s2">&quot;h&quot;</span></code></li>
</ul>
</li>
<li>This is explained later, in functions.</li>
</ol>
<p>The major breakdown of this initializer is:</p>
<ul>
<li><strong>First highlighted section:</strong> Load basic objects</li>
<li><strong>Second highlighted section:</strong> Read configuration options</li>
<li><strong>Third highlighted section:</strong> Register GCode commands</li>
</ul>
<p>The line <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span></code> will be explained later in functions.</p>
<div class="admonition question">
<p class="admonition-title">Quiz</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Question</label><label for="__tabbed_1_2">Answer</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>How would you add another trigger type (called <code class="highlight"><span class="s2">&quot;axes_distance&quot;</span></code> with units <code class="highlight"><span class="s2">&quot;m&quot;</span></code>)?</p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">(</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span class="s1">&#39;print_time&#39;</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="s1">&#39;filament&#39;</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="s1">&#39;time&#39;</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="hll">    <span class="s1">&#39;axes_distance&#39;</span><span class="p">])</span>
</span><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="c1"># (3)!</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="hll"><span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;axes_distance&#39;</span><span class="p">:</span>
</span><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<h3 id="functions">Functions</h3>
<p>The next part of the <code>Maintain</code> class is its functions. The functions in this class are, broken down into two sections:</p>
<p><strong>Database:</strong></p>
<ul>
<li><code>fetch_history()</code></li>
<li><code>init_db()</code></li>
<li><code>fetch_db()</code></li>
<li><code>update_db(new)</code></li>
</ul>
<p><strong>GCode:</strong></p>
<ul>
<li><code>get_remaining()</code></li>
<li><code>cmd_CHECK_MAINTENANCE(gcmd)</code></li>
<li><code>cmd_UPDATE_MAINTENANCE(gcmd)</code></li>
</ul>
<p>First, the database functions (again, plus signs throughout the code explain in more detail what each part does):</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="o">...</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="k">def</span> <span class="nf">fetch_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">API_URL</span><span class="p">)</span> <span class="c1"># fetch data from Moonraker History API</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> 
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>                <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>                <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>            <span class="p">}</span> <span class="c1"># (1)!</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="n">job_totals</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;job_totals&#39;</span><span class="p">]</span> <span class="c1"># get job totals from JSON response</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>            <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>            <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_filament_used&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>        <span class="p">}</span> <span class="c1"># (2)!</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>    <span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()</span> <span class="c1"># Load the database</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># Update the database with history data</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>    <span class="k">def</span> <span class="nf">fetch_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># (3)!</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># JSON parse the file contents</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a>                <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>                <span class="k">return</span> <span class="n">data</span> <span class="c1"># Return parsed data</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a>    <span class="k">def</span> <span class="nf">update_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># (3)!</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># (4)!</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span> <span class="c1"># The &quot;w+&quot; file operator allows reading and writing</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># JSON parse the file contents</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a>                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="c1"># Update the file contents with the new data</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="c1"># JSON write the new data to the file</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a>        <span class="k">return</span> <span class="n">data</span> <span class="c1"># Return the new updated data</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>In case of an error, empty placeholder data is returned.</li>
<li>If history fetch was successful, return the data read from the Moonraker History API.</li>
<li>The <code>path</code> is (if the username is <code>pi</code> and <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">name</span></code> is <code class="highlight"><span class="s2">&quot;lubricate&quot;</span></code>) <code class="highlight"><span class="s2">&quot;/home/pi/maintain-db/lubricate&quot;</span></code>. Even though it has no file extension, it stores JSON data.</li>
<li>The first time running this, the <code>maintain-db</code> folder won't exist. <code>os.makedirs</code> creates the folder, and <code class="highlight"><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span></code> doesn't throw an error if it already exists.</li>
</ol>
<p>The flow of information in this Klippy extra is:</p>
<ul>
<li><code>init_db()</code> is called when Klippy starts</li>
<li><code>fetch_db()</code> is called to read the stored database</li>
<li>If the data returned by <code>fetch_db()</code> is <code>None</code> (database is empty)<ul>
<li><code>fetch_history()</code> is called to fetch the history stored by Moonraker</li>
<li><code>update_db()</code> is called to update the database with the newly fetched data.</li>
</ul>
</li>
</ul>
<p>Calling <code>update_db()</code> will erase the current maintenance state (resetting the timer/filament counter).</p>
<hr />
<p>The next section of functions in the <code>Maintain</code> class are the GCode commands. There are three functions in this section:</p>
<ul>
<li><code>get_remaining()</code></li>
<li><code>cmd_CHECK_MAINTENANCE(gcmd)</code></li>
<li><code>cmd_UPDATE_MAINTENANCE(gcmd)</code></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="o">...</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="k">def</span> <span class="nf">get_remaining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># Returns the remaining hours/meters until this expires</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span> <span class="c1"># Get the last trigger</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span> <span class="c1"># Get the current state</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Return how close the difference is to self.threshold, and round to two decimal places</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>    <span class="n">cmd_CHECK_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Check maintenance&#39;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="k">def</span> <span class="nf">cmd_CHECK_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>        <span class="n">gcmd</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="s1">Maintenance </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> Status:</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="s1">Next maintenance in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="si">}</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="s1">Maintenance message: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>    <span class="n">cmd_UPDATE_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Update maintenance&#39;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="k">def</span> <span class="nf">cmd_UPDATE_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">())</span> <span class="c1"># (1)!</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>This erases the current maintenance status, and is called when maintenance has been done. <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()</span></code> retrieves the current state of the printer history (print time, filament), and then <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">()</span></code> saves that data to the JSON database.</li>
</ol>
<p>The first function, <code>get_remaining</code>, works as follows (assuming the trigger is <code>print_time</code> and threshold is <code>250</code>):</p>
<ol>
<li>Read the last print time that maintenance occured at</li>
<li>Read the current accumulated print time</li>
<li>Get the difference between the two (how long has it been since last maintenance?)</li>
<li>Subtract that from <code>threshold</code> (how much longer until maintenance should be done?)</li>
<li>Round to two decimal places and return</li>
</ol>
<p>The next function, <code>cmd_CHECK_MAINTENANCE</code>, corresponds to the GCode command <code>CHECK_MAINTENANCE</code>, and outputs the <code>Maintain</code> object's variables in a user-friendly format.</p>
<p>The final function, <code>cmd_UPDATE_MAINTENANCE</code>, corresponds to the GCode command <code>UPDATE_MAINTENANCE</code>, and erases the current maintenance state. Click the plus sign in the function for more information.</p>
<h2 id="maintenance-class">Maintenance Class</h2>
<p>Now that we've gone through the <code>Maintain</code> class, let's see how multiple <code>Maintain</code> objects are managed in the <code>Maintenance</code> class. This class does the following:</p>
<ul>
<li>Displays maintenance reminders</li>
<li>Provides the <code>MAINTAIN_STATUS</code> command to overview the current maintenance state</li>
</ul>
<p>Unlike the <code>Maintain</code> class, which has multiple objects, there will be only one <code>Maintenance</code> object. Let's start with the initializer.</p>
<h3 id="initializer_1">Initializer</h3>
<p>The initializer of the <code>Maintenance</code> class is shown below:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
</span><a id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</span><a id="__codelineno-6-9" name="__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="kc">None</span>
</span><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
</span><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span><span class="s2">&quot;klippy:ready&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_ready</span><span class="p">)</span>
</span><a id="__codelineno-6-13" name="__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span><span class="s1">&#39;MAINTAIN_STATUS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS_help</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>This initializer may look similar to the BetterGreeter initializer in the previous example. This is because both the <code>BetterGreeter</code> and <code>Maintenance</code> classes use Klipper's timer system to schedule events. </p>
<p>There are four highlighted sections in the above code block. Let's go through each of them and explain what they do. </p>
<ol>
<li>This sets up the <code>reactor</code> object, which is important in scheduling events with Klipper.</li>
<li>This reads the interval from the configuration, defaulting to <code class="highlight"><span class="mi">60</span></code> if no value is provided.</li>
<li>This section is based off the <code>delayed_gcode</code> code, which is builtin to Klipper. Source code <a href="https://github.com/Klipper3d/klipper/blob/12cd1d9e81c32b26ccc319af1dfc3633438908f1/klippy/extras/delayed_gcode.py">here</a>. This section declares a <code>timer_handler</code>, <code>inside_timer</code>, and <code>repeat</code> variables, all of which will be used later. The last line of this section registers the <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">_handle_ready</span></code> function to run when Klippy is ready.</li>
<li>This final line registers the <code class="highlight"><span class="s2">&quot;MAINTAIN_STATUS&quot;</span></code> GCode command.</li>
</ol>
<h3 id="functions_1">Functions</h3>
<p>The next part of the <code>Maintenance</code> class is its functions:</p>
<ul>
<li><code>_handle_ready</code></li>
<li><code>_gcode_timer_event</code></li>
<li><code>check_maintenance</code></li>
<li><code>cmd_MAINTAIN_STATUS</code></li>
</ul>
<p>Click on the plus symbols in the code below to learn more about specific parts.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintian.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span>
<span class="normal"><a href="#__codelineno-7-20">20</a></span>
<span class="normal"><a href="#__codelineno-7-21">21</a></span>
<span class="normal"><a href="#__codelineno-7-22">22</a></span>
<span class="normal"><a href="#__codelineno-7-23">23</a></span>
<span class="normal"><a href="#__codelineno-7-24">24</a></span>
<span class="normal"><a href="#__codelineno-7-25">25</a></span>
<span class="normal"><a href="#__codelineno-7-26">26</a></span>
<span class="normal"><a href="#__codelineno-7-27">27</a></span>
<span class="normal"><a href="#__codelineno-7-28">28</a></span>
<span class="normal"><a href="#__codelineno-7-29">29</a></span>
<span class="normal"><a href="#__codelineno-7-30">30</a></span>
<span class="normal"><a href="#__codelineno-7-31">31</a></span>
<span class="normal"><a href="#__codelineno-7-32">32</a></span>
<span class="normal"><a href="#__codelineno-7-33">33</a></span>
<span class="normal"><a href="#__codelineno-7-34">34</a></span>
<span class="normal"><a href="#__codelineno-7-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">def</span> <span class="nf">_handle_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="c1"># (1)!</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gcode_timer_event</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>    <span class="k">def</span> <span class="nf">_gcode_timer_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="p">):</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="c1"># This function is based on the delayed_gcode Klipper code.</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_maintenance</span><span class="p">()</span> <span class="c1"># Check if maintenance needs to be done.</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>        <span class="n">nextwake</span> <span class="o">=</span> <span class="n">eventtime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>        <span class="k">return</span> <span class="n">nextwake</span> <span class="c1"># (2)!</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>    <span class="k">def</span> <span class="nf">check_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (3)!</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span> <span class="c1"># (4)!</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>                <span class="k">continue</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># (5)!</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">run_script_from_command</span><span class="p">(</span><span class="s1">&#39;M117 Maintenance Expired!&#39;</span><span class="p">)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>    <span class="n">cmd_MAINTAIN_STATUS_help</span> <span class="o">=</span> <span class="s1">&#39;Check status of maintenance&#39;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>    <span class="k">def</span> <span class="nf">cmd_MAINTAIN_STATUS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span> <span class="c1"># Load all Maintain objects</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (3)!</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span> <span class="c1"># (4)!</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>                <span class="k">continue</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>            <span class="n">remain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span> <span class="c1"># You can call functions on other Klippy extras</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>            <span class="k">if</span> <span class="n">remain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># (5)!</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="n">obj</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1"> remaining&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<div class="admonition question">
<p class="admonition-title">Quiz</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Question</label><label for="__tabbed_2_2">Answer</label></div>
<div class="tabbed-content">
<div class="tabbed-block">What does <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span></code> return?</div>
<div class="tabbed-block"><code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span></code> returns the current Klippy time.</div>
</div>
</div>
</div>
</li>
<li>This is necessary for the timer to repeat. If you wanted to make this function not repeat, you can make it return <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">NEVER</span></code>.</li>
<li>Whenever you use <code class="highlight"><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span></code>, it will return a list of tuples, where each tuple contains, in order, the configuration name of the object, then the actual Python object.</li>
<li>Because the <code>Maintenance</code> class is also configured with a <code>[maintain]</code> config section (the difference being that <code>Maintenance</code> doesn't have a name, while <code>Maintain</code> does have a name, like <code>[maintain lubricate]</code>), a check has to be made to ensure a <code>Maintain</code> object has been found.</li>
<li><code class="highlight"><span class="k">if</span> <span class="n">get_remaining</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span></code>, the maintenance is expired and needs to be done.</li>
</ol>
<p>There are general flows of information in these functions:</p>
<p><strong>GCode Flow:</strong></p>
<ol>
<li><code>MAINTAIN_STATUS</code> is called from GCode</li>
<li><code>cmd_MAINTAIN_STATUS</code> is called in Python</li>
<li>All <code>Maintain</code> objects are retrieved</li>
<li>If a <code>Maintain</code> object is expired, notify the user in the terminal</li>
<li>Display the status of all <code>Maintain</code> objects</li>
</ol>
<p><strong>Timer Flow:</strong></p>
<ol>
<li>Klippy reports ready and calls <code>_handle_ready</code></li>
<li><code>_handle_ready</code> schedules an event to happen in <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">interval</span></code> seconds</li>
<li><code>_gcode_timer_event</code> is called by Klippy, and the maintenance is checked</li>
<li>Repeat step 3 until Klippy shuts down</li>
</ol>
<p>The first flow, the GCode flow, runs when the user manually runs the <code>MAINTAIN_STATUS</code> command. This makes it useful for checking how close certain maintenance objects are to being expired.</p>
<p>The second flow, the timer flow, runs behind the scenes as long as Klippy is running. This makes it useful for reminding the user if maintenance needs to be done without the need for manually checking.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Using a combination of GCode-initiated code, and timer-initiated code allows for Klippy extras to be more user-friendly.</p>
</div>
<h2 id="feedback">Feedback</h2>
<p>Was this tutorial helpful? Do you have any feedback for it? Are there any areas where you think this could be improved?</p>
<p>Let me know either on the <a href="https://klipper.discourse.group/t/klippy-extras-tutorial/18184?u=3dcoded">Klipper Discourse</a> or in a <a href="https://github.com/3DCoded/DynamicMacros/issues/new?assignees=&amp;labels=documentation&amp;projects=&amp;template=documentation.md&amp;title=%5BDOCS%5D">Documentation Issue</a> on Github.</p>
<p>Thank you for your feedback!</p>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Help us improve this page by <a href="https://github.com/3DCoded/DynamicMacros/issues/new?assignees=&labels=documentation&projects=&template=documentation.md&title=%5BDOCS%5D" target="_blank" rel="noopener">opening an issue</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../extras-ex2/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Example 2: BetterGreeter">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Example 2: BetterGreeter
              </div>
            </div>
          </a>
        
        
          
          <a href="../../examples/" class="md-footer__link md-footer__link--next" aria-label="Next: Example Macros">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Example Macros
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://3dcoded.github.io" target="_blank" rel="noopener" title="3dcoded.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.action.edit", "navigation.expand", "navigation.instant", "navigation.instant.prefetch", "navigation.footer", "content.code.copy", "content.code.annotate", "search.suggest", "search.highlight", "search.share"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
    
  </body>
</html>