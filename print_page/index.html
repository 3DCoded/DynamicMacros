
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://dynamicmacros.3dcoded.xyz/print_page/">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>Print Site - Klipper Dynamic Macros</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-1YVCJR4FQR"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-1YVCJR4FQR",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-1YVCJR4FQR",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Klipper Dynamic Macros" class="md-header__button md-logo" aria-label="Klipper Dynamic Macros" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Klipper Dynamic Macros
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/3dcoded/DynamicMacros" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../setup/" class="md-tabs__link">
          
  
  DynamicMacros

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../extras/extras-start/" class="md-tabs__link">
          
  
  Klippy Extras

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Klipper Dynamic Macros" class="md-nav__button md-logo" aria-label="Klipper Dynamic Macros" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    Klipper Dynamic Macros
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/3dcoded/DynamicMacros" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    DynamicMacros
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            DynamicMacros
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setup
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorial
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Tutorial
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Table of Contents
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/converting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Converting to Dynamic Macros
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/usingfeatures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Dynamic Macros Features
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tutorial/experimental/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Experimental Features
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Features
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/recursion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Recursion
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/receivingvariables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving Variable Updates
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/utilities/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Utility Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/variables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Variables
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/python/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Python
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/delayed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Delayed GCode
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/clusters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Macro Clusters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../features/rendering/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dynamic Rendering
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example Macros
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../devstatus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Status
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Klippy Extras
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Klippy Extras
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras/extras-start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Start Writing Klippy Extras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras/extras-intro/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction to Writing Klippy Extras
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras/extras-ex1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example 1: Greeter (Structure)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras/extras-ex2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example 2: BetterGreeter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extras/extras-ex3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example 3: KlipperMaintenance
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    <span class="md-ellipsis">
      1. Home
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-dynamicmacros" class="md-nav__link">
    <span class="md-ellipsis">
      I. DynamicMacros
    </span>
  </a>
  
    <nav class="md-nav" aria-label="I. DynamicMacros">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    <span class="md-ellipsis">
      2. Setup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#examples" class="md-nav__link">
    <span class="md-ellipsis">
      3. Example Macros
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#devstatus" class="md-nav__link">
    <span class="md-ellipsis">
      4. Development Status
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-klippy-extras" class="md-nav__link">
    <span class="md-ellipsis">
      II. Klippy Extras
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II. Klippy Extras">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#extras-extras-start" class="md-nav__link">
    <span class="md-ellipsis">
      5. Start Writing Klippy Extras
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extras-extras-intro" class="md-nav__link">
    <span class="md-ellipsis">
      6. Introduction to Writing Klippy Extras
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extras-extras-ex1" class="md-nav__link">
    <span class="md-ellipsis">
      7. Example 1: Greeter (Structure)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extras-extras-ex2" class="md-nav__link">
    <span class="md-ellipsis">
      8. Example 2: BetterGreeter
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extras-extras-ex3" class="md-nav__link">
    <span class="md-ellipsis">
      9. Example 3: KlipperMaintenance
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                




                  


<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index"><h1 id="index-klipper-dynamic-macros">Klipper Dynamic Macros</h1>
<p><strong>Never restart Klipper again for simple macros.</strong></p>
<p><img src="../assets/logo.png" alt="logo" width="200"/></p>
<hr />
<p>Klipper Dynamic Macros is an unofficial way to update macros without restarting Klipper, so you can update macros mid-print and see their results live. It also supports extra features that normal GCode Macros don't have.</p>
<h2 id="index-features">Features</h2>
<ul>
<li><a href="#features-recursion">Recursion</a></li>
<li><a href="#features-receivingvariables">Receiving Variables</a></li>
<li><a href="#features-utilities">Utility Functions</a></li>
<li><a href="#features-variables">Variables</a></li>
<li><a href="#features-python">Python</a></li>
<li><a href="#features-delayed">Delayed GCode</a></li>
<li><a href="#features-clusters">Macro Clusters</a></li>
<li><a href="#features-rendering">Rendering Macros</a></li>
</ul>
<h2 id="index-how-normal-macros-work">How Normal Macros Work</h2>
<p>Your macros are written in a <code>.cfg</code> file, then included into your <code>printer.cfg</code>. When Klipper restarts, it parses these files and saves the macros internally (you can't change them without restarting Klipper). When a macro is called, the cached code is interpreted and run.</p>
<h2 id="index-how-dynamic-macros-work">How Dynamic Macros Work</h2>
<p>Your macros are written in a <code>.cfg</code> file, then the relative path to that file is configured in a <code>[dynamicmacros]</code> config section. The config files are read and parsed every time you run the <code>DYNAMIC_MACRO</code> command, allowing you to update macros without restarting Klipper.</p>
<p>Dynamic Macros are defined in a separate file and <strong>not</strong> included in your <code>printer.cfg</code>. They are instead read by a <code>[dynamicmacros]</code> section in your <code>printer.cfg</code>. </p>
<h2 id="index-klippy-extras-tutorial">Klippy Extras Tutorial</h2>
<p>DynamicMacros also includes a <a href="#extras-extras-start">tutorial on writing Klippy extras</a>.</p>
<h2 id="index-get-started">Get Started</h2>
<p>Follow <a href="#setup">Setup</a> to get started with Dynamic Macros.</p>
<h2 id="index-planned-features">Planned Features</h2>
<p>See <a href="#devstatus">Development Status</a> for the currently available features, and planned features.</p>
<h2 id="index-examples">Examples</h2>
<p>See <a href="#examples">Example Macros</a> for examples of Dynamic Macros.</p>
<h2 id="index-more-projects">More Projects</h2>
<p>If you like this project, don't forget to give it a star! Also, check out the <a href="https://github.com/3dcoded/3ms">3MS</a>, a modular multimaterial system for Klipper!</p></section>
                        <h1 class='nav-section-title' id='section-dynamicmacros'>
                            DynamicMacros <a class='headerlink' href='#section-dynamicmacros' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="setup"><h1 id="setup-setup">Setup</h1>
<p>Follow this guide to setup and confiure Dynamic Macros.</p>
<h2 id="setup-install">Install</h2>
<p>Run in your terminal:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#setup-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#setup-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#setup-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#setup-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nb">cd</span><span class="w"> </span>~
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/3DCoded/DynamicMacros
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nb">cd</span><span class="w"> </span>DynamicMacros
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>sh<span class="w"> </span>install.sh
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>sudo<span class="w"> </span>service<span class="w"> </span>klipper<span class="w"> </span>restart
</code></pre></div></td></tr></table></div>
<p>Add to your <code>moonraker.conf</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">moonraker.conf</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#setup-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#setup-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#setup-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#setup-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#setup-__codelineno-1-6">6</a></span>
<span class="normal"><a href="#setup-__codelineno-1-7">7</a></span>
<span class="normal"><a href="#setup-__codelineno-1-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># DynamicMacros Update Manager</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="k">[update_manager DynamicMacros]</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">type</span><span class="o">:</span><span class="w"> </span><span class="s">git_repo</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="na">path</span><span class="o">:</span><span class="w"> </span><span class="s">~/DynamicMacros</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">origin</span><span class="o">:</span><span class="w"> </span><span class="s">https://github.com/3DCoded/DynamicMacros.git</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="na">primary_branch</span><span class="o">:</span><span class="w"> </span><span class="s">main</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="na">is_system_service</span><span class="o">:</span><span class="w"> </span><span class="s">False</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="na">install_script</span><span class="o">:</span><span class="w"> </span><span class="s">install.sh</span>
</code></pre></div></td></tr></table></div>
<h2 id="setup-updating">Updating</h2>
<p>First, update via Moonraker's update manager. Then run in your terminal:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#setup-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#setup-__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">cd</span><span class="w"> </span>~/DynamicMacros
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>sh<span class="w"> </span>install.sh
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>sudo<span class="w"> </span>service<span class="w"> </span>klipper<span class="w"> </span>restart
</code></pre></div></td></tr></table></div>
<h2 id="setup-configuration">Configuration</h2>
<p>To configure Dynamic Macros, put in your <code>printer.cfg</code> (or a file included in it):</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">printer.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#setup-__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">[dynamicmacros]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="na">configs</span><span class="o">:</span><span class="w"> </span><span class="s">dynamic.cfg</span>
</code></pre></div></td></tr></table></div>
<p>Create a new file in the same folder as your <code>printer.cfg</code> called <code>dynamic.cfg</code>. In it, configure some macros like you normally would. Example:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">dynamic.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#setup-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#setup-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#setup-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#setup-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#setup-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#setup-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#setup-__codelineno-4-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">[gcode_macro MYTEST]</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="na">M117 Hello world!</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="k">[gcode_macro HEAT_HOTEND]</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="na">{% set temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.TEMP|int %}</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="na">M104 S{temp}</span>
</code></pre></div></td></tr></table></div>
<p>Restart Klipper.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Updating the <code>[dynamicmacros]</code> config section requires a Klipper restart. The files listed in the <code>macros:</code> parameter must be present when Klipper restarts.</p>
</div>
<h2 id="setup-testing">Testing</h2>
<p>If you run the command <code>MYTEST</code>, the output should be:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>Hello world!
</code></pre></div></td></tr></table></div></p>
<p>If you runthe command <code>HEAT_HOTEND TEMP=200</code>, the hotend should start heating up. </p>
<p>Next, edit the <code>MYTEST</code> macro to output something else, like <code>Test successful!</code></p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">dynamic.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#setup-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#setup-__codelineno-6-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">[gcode_macro MYTEST]</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="na">M117 Test successful!</span>
</code></pre></div></td></tr></table></div>
<p>Save the file, but <strong>do not</strong> restart Klipper.</p>
<p>Run the <code>DYNAMIC_MACRO</code> command to reload the macros.</p>
<p>Run <code>MYTEST</code> again, and the output should be:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a>Test successful!
</code></pre></div></td></tr></table></div></p>
<h2 id="setup-features">Features</h2>
<ul>
<li><a href="#features-recursion">Recursion</a></li>
<li><a href="#features-receivingvariables">Receiving Variable Updates</a></li>
<li><a href="#features-utilities">Utility Functions</a></li>
<li><a href="#features-variables">Variables</a></li>
</ul>
<h2 id="setup-tutorial">Tutorial</h2>
<p>Follow the <a href="#tutorial">Tutorial</a>.</p>
<h2 id="setup-when-to-restart-klipper-or-reload-dynamic-macros">When to Restart Klipper or Reload Dynamic Macros</h2>
<p>Dynamic Macros provides a utility <code>DYNAMIC_MACRO</code> command to run macros manually, and to refresh the macros. Usage examples (assuming M900 is defined as a Dynamic Macro):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a>DYNAMIC_MACRO MACRO=M900 K=0.035
</code></pre></div></td></tr></table></div>
<p>is the same as:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#setup-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>M900 K0.035
</code></pre></div></td></tr></table></div>
<p>To refresh Dynamic Macros, just run <code>DYNAMIC_MACRO</code> with no parameters.</p>
<p>A Klipper restart is required if:</p>
<ul>
<li>You changed the <code>description</code></li>
<li>You changed the <code>initial_duration</code></li>
<li>You changed the <code>repeat</code></li>
</ul>
<p>A <code>DYNAMIC_MACRO</code> refresh is required if:</p>
<ul>
<li>You created a new macro</li>
<li>You renamed an existing macro</li>
<li>You changed the contents of a macro</li>
<li>You deleted an existing macro</li>
</ul></section>
                        <h2 class='nav-section-title' id='section-tutorial'>
                            Tutorial <a class='headerlink' href='#section-tutorial' title='Permanent link'>↵</a>
                        </h2>
                        <section class="print-page" id="tutorial"><h1 id="tutorial-table-of-contents">Table of Contents</h1>
<p>Follow this tutorial to learn how to create Dynamic Macros and to use its powerful features.</p>
<h2 id="tutorial-standard-macros">Standard Macros</h2>
<p>Before writing macros, it's a good idea to learn how to write standard <code>gcode_macro</code>s. <a href="https://klipper.discourse.group/t/macro-creation-tutorial/30">Here</a> is an amazing guide on how to write standard macros.</p>
<h2 id="tutorial-table-of-contents_1">Table of Contents</h2>
<ol>
<li><a href="#tutorial-converting">Converting to Dynamic Macros</a></li>
<li><a href="#tutorial-usingfeatures">Using Dynamic Macros Features</a></li>
<li><a href="#tutorial-experimental">Experimental Features</a></li>
</ol></section><section class="print-page" id="tutorial-converting"><h1 id="tutorial-converting-converting-to-dynamic-macros">Converting to Dynamic Macros</h1>
<p>Follow this tutorial to convert your standard <code>gcode_macro</code> to a Dynamic Macro. </p>
<h2 id="tutorial-converting-printercfg">printer.cfg</h2>
<p>First, remove the <code>include</code> line in your <code>printer.cfg</code> referencing the file your macros are in. For example, if your macros are in <code>macros.cfg</code>, remove the line:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#tutorial-converting-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[include macros.cfg]</span>
</code></pre></div></td></tr></table></div>
<p>from your <code>printer.cfg</code>.</p>
<h2 id="tutorial-converting-dynamic-macros-configuration">Dynamic Macros Configuration</h2>
<p>Next, if you don't already have one, create a <code>[dynamicmacros]</code> config section in your <code>printer.cfg</code> and add your macro configuration to it:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">printer.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#tutorial-converting-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[dynamicmacros]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">configs</span><span class="o">:</span><span class="w"> </span><span class="s">macros.cfg</span><span class="w"> </span><span class="c1"># You can add more files to this list, separated by commas.</span>
</code></pre></div></td></tr></table></div>
<details class="tip">
<summary>Interface Workaround (old Fluidd, KlipperScreen, Macro parameters)</summary>
<p>If your Fluidd/Mainsail macros list is empty, your macro parameters don't show up in your favorite UI, or your dynamic macros don't appear in KlipperScreen's macros list, you can add the following parameter to your <code>[dynamicmacros]</code> config section:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#tutorial-converting-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="na">interface_workaround</span><span class="o">:</span><span class="w"> </span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
</details>
<details class="tip">
<summary>KlipperScreen</summary>
<p>If you convert your <code>LOAD_FILAMENT</code> and <code>UNLOAD_FILAMENT</code> macros to be dynamic, KlipperScreen may not recognize them and report an error. To fix this, add blank macros to your <code>printer.cfg</code>, before your <code>[dynamicmacros]</code> section. Example:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">printer.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#tutorial-converting-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-3-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">[gcode_macro LOAD_FILAMENT]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="na">M117 LOAD</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="k">[gcode_macro UNLOAD_FILAMENT]</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="na">M117 UNLOAD</span>
</code></pre></div></td></tr></table></div></p>
</details>
<details class="failure">
<summary>Unknown config object 'gcode_macro'</summary>
<p>If you are getting a "Unknown config object 'gcode_macro'" error after converting your macros to Dynamic Macros, move your <code>[dynamicmacros]</code> section to be after your <code>[virtual_sdcard]</code> section.</p>
</details>
<details class="tip">
<summary>Macro Names</summary>
<p>Klipper has certain macro names reserved for core functionality. If you are experiencing errors, don't name your Dynamic Macros any of the following:</p>
<ul>
<li><code>PAUSE</code></li>
<li><code>RESUME</code></li>
<li><code>CANCEL_PRINT</code></li>
</ul>
<p>If you want to make those macros dynamic, first define them as a <strong>standard</strong> GCode macro:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#tutorial-converting-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#tutorial-converting-__codelineno-4-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">[gcode_macro PAUSE]</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="na">DYNAMIC_PAUSE</span>
</code></pre></div></td></tr></table></div>
</details>
<p>Restart Klipper.</p>
<p>That's it. Your macros are now Dynamic Macros.</p></section><section class="print-page" id="tutorial-usingfeatures"><h1 id="tutorial-usingfeatures-using-dynamic-macros-features">Using Dynamic Macros Features</h1>
<p>Now that your macros are dynamic, you can use the powerful feature set of Dynamic Macros.</p>
<h2 id="tutorial-usingfeatures-recursion"><a href="#features-recursion">Recursion</a></h2>
<p>Recursion allows a macro to call itself, something standard GCode macros can't do. </p>
<p>When using recursion, it's important to make sure your macro has an "end case". This is a case when the macro won't call itself again. Otherwise the macro will be stuck in an infinite loop and freeze Klipper.</p>
<p>Here are a few examples of recursion:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Counting to 10</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-8">8</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[gcode_macro COUNT]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="na">{% set num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.NUM|default(1)|int %}</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="na">{% if num &lt;</span><span class="o">=</span><span class="w"> </span><span class="s">10 %}</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">{num}</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">        </span><span class="na">COUNT NUM</span><span class="o">=</span><span class="s">{num+1}</span><span class="w"> </span><span class="c1"># Count up 1</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="na">{% else %}</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;Done Counting&quot;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="na">{% endif %}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Load to Filament Sensor</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#tutorial-usingfeatures-__codelineno-1-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[gcode_macro LOAD_TO_FSENSOR]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="na">{% set val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">printer[&quot;filament_sensor fsensor&quot;].filament_detected %}</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="na">{% if val</span><span class="w"> </span><span class="o">=</span><span class="s">= 0 %}</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span><span class="na">M83</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="na">G1 E50 F900 # Move filament 50mm forwards</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;Waiting for fsensor&quot;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="na">LOAD_TO_FSENSOR # Recursion</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="na">{% else %}</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="na">G1 E65 F900 # Move filament to nozzle</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;Filament Loaded&quot;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="na">{% endif %}</span>
</code></pre></div></td></tr></table></div>
<h2 id="tutorial-usingfeatures-receiving-variable-updates"><a href="#features-receivingvariables">Receiving Variable Updates</a></h2>
<p>Receiving variable updates allows Dynamic Macros to update variables without rerunning the macro. </p>
<p>An example of this is getting the printer's position. A standard GCode macro will evaluate all the variables, then run the GCode. However, using three newlines (two blank lines) between code segments in Dynamic Macros will allow each segment to be evaluated at runtime, allowing for variable updates.</p>
<h2 id="tutorial-usingfeatures-utility-functions"><a href="#features-utilities">Utility Functions</a></h2>
<p>See the link above (the subtitle) for more information on utility functions.</p>
<h2 id="tutorial-usingfeatures-python"><a href="#features-python">Python</a></h2>
<p>Dynamic Macro's most powerful feature allows you to run Python code from within a macro. See the link above (the subtitle) for more information.</p>
<h2 id="tutorial-usingfeatures-delayed_gcode"><a href="#features-delayed">delayed_gcode</a></h2>
<p>Dynamic Macros supports a feature similar to <code>delayed_gcode</code>. See the link above (the subtitle) for more information.</p></section><section class="print-page" id="tutorial-experimental"><h1 id="tutorial-experimental-experimental-features">Experimental Features</h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The features on this page are experimental, and untested or only lightly tested. Proceed at your own risk.</p>
</div></section><h1 class='nav-section-title-end'>Ended: Tutorial</h1>
                        <h2 class='nav-section-title' id='section-features'>
                            Features <a class='headerlink' href='#section-features' title='Permanent link'>↵</a>
                        </h2>
                        <section class="print-page" id="features-recursion"><h1 id="features-recursion-recursion">Recursion</h1>
<p>Unlike normal <code>gcode_macro</code>s, Dynamic Macros supports recursion (allowing a macro to call itself). For more examples, see <a href="#examples-recursion">Examples</a></p></section><section class="print-page" id="features-receivingvariables"><h1 id="features-receivingvariables-receiving-variable-updates">Receiving Variable Updates</h1>
<p>Unlike normal <code>gcode_macro</code>s, Dynamic Macros supports receiving variable updates within the same macro. For example, the following macro will show the same output in both <code>M117</code>s:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-receivingvariables-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-8">8</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[gcode_macro STATIC_MOVE]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="na">G28</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="na">M117 Before</span><span class="o">:</span><span class="w"> </span><span class="s">{printer.toolhead.position.z}</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="c1"># Above displays position before macro run</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="na">G90</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="na">G1 Z20</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="na">M117 After</span><span class="o">:</span><span class="w"> </span><span class="s">{printer.toolhead.position.z}</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="c1"># Above displays same position</span>
</code></pre></div></td></tr></table></div>
<p>However, this macro will show different outputs based on the current Z position of the toolhead:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-receivingvariables-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[gcode_macro DYNAMIC_MOVE]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="na">G28</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="na">---</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="na">M117 Before</span><span class="o">:</span><span class="w"> </span><span class="s">{printer.toolhead.position.z}</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">  </span><span class="c1"># Above displays position after G28</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">  </span><span class="na">G90</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">  </span><span class="na">G1 Z20</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">  </span><span class="na">---</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">  </span><span class="na">M117 After</span><span class="o">:</span><span class="w"> </span><span class="s">{printer.toolhead.position.z}</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">  </span><span class="c1"># Above displays position after G1</span>
</code></pre></div></td></tr></table></div>
<p>Notice the <code>---</code>. Three dashes between code segments denotes a variable update. However, some variables won't be preserevd across the split.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-receivingvariables-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-2-6">6</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-2-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">[gcode_macro VARIABLES]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="na">{% set num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10 %}</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="na">M117 {num}</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="na">---</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="na">M117 {num}</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="c1"># Above line outputs nothing</span>
</code></pre></div></td></tr></table></div>
<p>You can use the <code>update()</code> function to preserve certain variables across the splits:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-receivingvariables-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-3-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">[gcode_macro VARIABLES]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="na">{% set num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">update(&quot;num&quot;, 10) %}</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="na">M117 {num}</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="na">---</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="na">M117 {num}</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="c1"># Above line outputs 10</span>
</code></pre></div></td></tr></table></div>
<p>See <a href="#examples-receiving-position-updates">Examples</a> for examples.</p>
<h2 id="features-receivingvariables-custom-delimiters">Custom Delimiters</h2>
<p>To split a macro by something other than <code>---</code>, you can set the <code>delimiter</code> parameter in your <code>[dynamicmacros]</code> config section:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-receivingvariables-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#features-receivingvariables-__codelineno-4-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">[dynamicmacros]</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="na">configs</span><span class="o">:</span><span class="w"> </span><span class="s">dynamic.cfg,macros.cfg</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="na">delimiter</span><span class="o">:</span><span class="w"> </span><span class="s">SPLIT_HERE</span>
</code></pre></div></td></tr></table></div>
<p>To disable receiving variable updates entirely, you can set <code>delimiter</code> to <code>NO_DELIMITER</code>.</p></section><section class="print-page" id="features-utilities"><h1 id="features-utilities-utility-functions">Utility Functions</h1>
<p>Dynamic Macros provides a few utility functions to make Dynamic Macros easier to write.</p>
<h2 id="features-utilities-update">update()</h2>
<p>The <code>update()</code> function allows to save variables across whitespaces (see <a href="#features-receivingvariables">Receiving Variables</a> for more information). Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-utilities-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-0-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[gcode_macro MY_MACRO]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="na">{% set a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">10 %}</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="na">{% set b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">update(&quot;b&quot;, 20) %}</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;A: {a}&quot;</span><span class="w"> </span><span class="c1"># 10</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;B: {b}&quot;</span><span class="w"> </span><span class="c1"># 20</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;A: {a}&quot;</span><span class="w"> </span><span class="c1"># &quot;&quot;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;B: {b}&quot;</span><span class="w"> </span><span class="c1"># 20</span>
</code></pre></div></td></tr></table></div>
<h2 id="features-utilities-get_macro_variables">get_macro_variables()</h2>
<p>The <code>get_macro_variables()</code> function allows to retrieve all the variables from another macro in one line of code. Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-utilities-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[gcode_macro MY_SETTINGS]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">variable_a</span><span class="o">:</span><span class="w"> </span><span class="s">10</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">variable_b</span><span class="o">:</span><span class="w"> </span><span class="s">20</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;settings&quot;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="k">[gcode_macro GET_SETTINGS]</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="na">{% set settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">get_macro_variables(&quot;MY_SETTINGS&quot;) %}</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;Settings: {settings}&quot;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;A: {settings.a}&quot;</span>
</code></pre></div></td></tr></table></div>
<h2 id="features-utilities-update_from_dict">update_from_dict()</h2>
<p>The <code>update_from_dict()</code> function allows for saving the output of <code>get_macro_variables()</code> (or other dictionaries) across the whitespaces when <a href="#features-receivingvariables">Receiving Variables</a>. Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-utilities-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#features-utilities-__codelineno-2-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">[gcode_macro MY_SETTINGS]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="na">variable_a</span><span class="o">:</span><span class="w"> </span><span class="s">10</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="na">variable_b</span><span class="o">:</span><span class="w"> </span><span class="s">20</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;settings&quot;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="k">[gcode_macro GET_SETTINGS]</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="na">{% set settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">get_macro_variables(&quot;MY_SETTINGS&quot;) %}</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="na">{% set settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">update_from_dict(settings) %}</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;A: {a}&quot;</span><span class="w"> </span><span class="c1"># 10</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;B: {b}&quot;</span><span class="w"> </span><span class="c1"># 20</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="features-variables"><h1 id="features-variables-variables">Variables</h1>
<p>Dynamic Macro variables work nearly the same way as standard <code>gcode_macro</code> variables. This guide covers the differences.</p>
<h2 id="features-variables-set_dynamic_variable">SET_DYNAMIC_VARIABLE</h2>
<p>Instead of using <code>SET_GCODE_VARIABLE</code>, Dynamic Macros use <code>SET_DYNAMIC_VARIABLE</code> to update Dynamic Macro variables. Example (assuming <code>VAR_TEST</code> is defined from <a href="#features-utilities">Utilities</a>):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-variables-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>SET_DYNAMIC_VARIABLE MACRO=var_test VARIABLE=a VALUE=15
</code></pre></div></td></tr></table></div></section><section class="print-page" id="features-python"><h1 id="features-python-python">Python</h1>
<p>Dynamic Macros's most powerful feature allows you to run Python code directly from within a macro.</p>
<h2 id="features-python-running-python-from-within-a-macro">Running Python from within a Macro</h2>
<div class="admonition note">
<p class="admonition-title">Disclaimer</p>
<p>This functionality allows Dynamic Macros to gain significant control over your printer and Klipper host. I am not responsible for whatever happens if you download a malicious macro.</p>
</div>
<p>There are three main reasons why this could be helpful:</p>
<ol>
<li>Allowing for deeper control of Klipper and the Klipper host</li>
<li>A learning bridge for creating Klipper plugins/extras</li>
<li>A tool to help develop Klipper plugins/extras without restarting Klipper</li>
</ol>
<p>To run Python from within a Dynamic Macro, use either the <code>python()</code> utility function, or the <code>python_file()</code> utility function. The <code>python()</code> function accepts python code as a multiline string, and the <code>python_file()</code> function accepts a filename (relative to your <code>printer.cfg</code> folder).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>When using the <code>python()</code> utility function, Jinja2 (which converts the macro to GCode) may throw errors during parsing. If you are getting errors, it is recommended to switch to <code>python_file()</code>.</p>
</div>
<p>Here are a few examples:</p>
<h3 id="features-python-python-math">Python Math</h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">macros.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-python-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-8">8</a></span>
<span class="normal"><a href="#features-python-__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[gcode_macro MATH]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="na">{% set value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">python(&quot;&quot;&quot;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="na">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">kwargs[&#39;a&#39;]</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="na">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">kwargs[&#39;b&#39;]</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="na">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">a + b</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="na">output(c)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="na">&quot;&quot;&quot;, a</span><span class="o">=</span><span class="s">1, b=2) %}</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">{value}</span>
</code></pre></div></td></tr></table></div>
<h3 id="features-python-python-file-running-gcode">Python File Running GCode</h3>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">macros.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-python-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#features-python-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#features-python-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#features-python-__codelineno-1-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[gcode_macro PYFILE]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="na">{% set value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">python_file(&quot;test.py&quot;) %}</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">{value}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">test.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-python-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#features-python-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#features-python-__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello from Python!&quot;</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">gcode</span><span class="p">(</span><span class="s2">&quot;G28</span><span class="se">\n</span><span class="s2">G1 X100 Y100 Z100 F1200&quot;</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="n">output</span><span class="p">(</span><span class="s2">&quot;GCode Executed&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="admonition info">
<p class="admonition-title">Where does the Python file go?</p>
<p>Python files run by <code>python_file()</code> should be placed in the same folder as your <code>printer.cfg</code></p>
</div>
<h3 id="features-python-no-return-variables">No Return Variables</h3>
<p>To run Python without a return variable, you can use <code>{% set _ = python... %}</code></p>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">macros.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-python-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#features-python-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#features-python-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">[gcode_macro NO_RETURN]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="na">{% set _</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">python(&quot;gcode(&#39;RESPOND MSG=\&#39;hello!\&#39;&#39;)) %}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="features-delayed"><h1 id="features-delayed-delayed-gcode">Delayed GCode</h1>
<p>Dynamic Macros supports a feature similar to <code>delayed_gcode</code>.</p>
<h2 id="features-delayed-configuration">Configuration</h2>
<p>To configure a DynamicMacro to be run repeatedly/after a delay, update your macro as follows:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="features-delayed-__tabbed_1_1" name="features-delayed-__tabbed_1" type="radio" /><input id="features-delayed-__tabbed_1_2" name="features-delayed-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="features-delayed-__tabbed_1_1">Before</label><label for="features-delayed-__tabbed_1_2">After</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-delayed-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#features-delayed-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#features-delayed-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[gcode_macro test]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;test&quot;</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-delayed-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#features-delayed-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#features-delayed-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#features-delayed-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#features-delayed-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[gcode_macro test]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">initial_duration</span><span class="o">:</span><span class="w"> </span><span class="s">2</span><span class="w"> </span><span class="c1"># Wait two seconds after Klipper starts to run this, and two seconds between repeats (if enabled)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">repeat</span><span class="o">:</span><span class="w"> </span><span class="s">true</span><span class="w"> </span><span class="c1"># true means repeat, false means don&#39;t repeat</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;test&quot;</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h2 id="features-delayed-parameters">Parameters</h2>
<p><code>initial_duration</code> specifies the delay after Klipper starts that the macro will be run, and the duration between repeats, if <code>repeat</code> is true.</p>
<p><code>repeat</code> specifies whether or not to repeat the macro.</p></section><section class="print-page" id="features-clusters"><h1 id="features-clusters-macro-clusters">Macro Clusters</h1>
<p>Dynamic Macro clusters allow for multiple <code>[dynamicmacros]</code> configuration sections, and allow for security features. </p>
<p>To configure a Dynamic Macro cluster, create a <code>[dynamicmacros name]</code> section shown below:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-clusters-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[dynamicmacros mycluster]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">configs</span><span class="o">:</span><span class="w"> </span><span class="s">cluster.cfg</span>
</code></pre></div></td></tr></table></div>
<p>This section is configured mostly the same as a standard <code>[dynamicmacros]</code> config section. The differences between clusters and standard syntax are two parameters:</p>
<ul>
<li><code>python_enabled</code></li>
<li><code>printer_enabled</code></li>
</ul>
<p>By default, both of these are set to <code>true</code>. If you want to disable either the Python functionality, or accessing the <code>printer</code> object, you can change the configuration as shown below:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="features-clusters-__tabbed_1_1" name="features-clusters-__tabbed_1" type="radio" /><input id="features-clusters-__tabbed_1_2" name="features-clusters-__tabbed_1" type="radio" /><input id="features-clusters-__tabbed_1_3" name="features-clusters-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="features-clusters-__tabbed_1_1">Disable Python</label><label for="features-clusters-__tabbed_1_2">Disable Printer</label><label for="features-clusters-__tabbed_1_3">Disable Both</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-clusters-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-1-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[dynamicmacros mycluster]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">configs</span><span class="o">:</span><span class="w"> </span><span class="s">cluster.cfg</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="hll"><span class="na">python_enabled</span><span class="o">:</span><span class="w"> </span><span class="s">false</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-clusters-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">[dynamicmacros mycluster]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="na">configs</span><span class="o">:</span><span class="w"> </span><span class="s">cluster.cfg</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="hll"><span class="na">printer_enabled</span><span class="o">:</span><span class="w"> </span><span class="s">false</span>
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-clusters-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#features-clusters-__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">[dynamicmacros mycluster]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="na">configs</span><span class="o">:</span><span class="w"> </span><span class="s">cluster.cfg</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="hll"><span class="na">python_enabled</span><span class="o">:</span><span class="w"> </span><span class="s">false</span>
</span><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="hll"><span class="na">printer_enabled</span><span class="o">:</span><span class="w"> </span><span class="s">false</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div></section><section class="print-page" id="features-rendering"><h1 id="features-rendering-dynamic-rendering">Dynamic Rendering</h1>
<p>DynamicMacros includes a <code>DYNAMIC_RENDER</code> command, useful for developing new macros.</p>
<h2 id="features-rendering-how-macros-are-run">How Macros are Run</h2>
<p>All Klipper macros (including standard macros) are "rendered" before being run. For example, the following macro:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-rendering-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#features-rendering-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#features-rendering-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[gcode_macro test]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="na">M117 {params.A}</span>
</code></pre></div></td></tr></table></div>
<p>When the command <code>test A=2</code> is run, <code>2</code> is displayed on the printer's screen. </p>
<p>When a macro is run, it is first rendered, then run. For example (click on the tabs):</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:3"><input checked="checked" id="features-rendering-__tabbed_1_1" name="features-rendering-__tabbed_1" type="radio" /><input id="features-rendering-__tabbed_1_2" name="features-rendering-__tabbed_1" type="radio" /><input id="features-rendering-__tabbed_1_3" name="features-rendering-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="features-rendering-__tabbed_1_1">macros.cfg</label><label for="features-rendering-__tabbed_1_2">Rendered</label><label for="features-rendering-__tabbed_1_3">Result</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-rendering-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">M117 {params.A}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<p>Assuming the macro is run with <code>A=2</code>:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-rendering-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="na">M117 2</span>
</code></pre></div></td></tr></table></div></p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-rendering-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>2
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h2 id="features-rendering-using-the-dynamic_render-command">Using the <code>DYNAMIC_RENDER</code> command</h2>
<p>The <code>DYNAMIC_RENDER</code> command is used the same way as the <code>DYNAMIC_MACRO</code> command. However, instead of running the macro, it will render the macro, as explained above, then print out the result to the Klipper console. Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-rendering-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>DYNAMIC_RENDER MACRO=test A=2
</code></pre></div></td></tr></table></div>
<p>will display</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#features-rendering-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#features-rendering-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#features-rendering-__codelineno-5-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>Rendered TEST:
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>M117 2
</code></pre></div></td></tr></table></div></section><h1 class='nav-section-title-end'>Ended: Features</h1><section class="print-page" id="examples"><h1 id="examples-example-macros">Example Macros</h1>
<p>This page will hold several different Dynamic Macro examples. Note that most of the examples here are specific to Dynamic Macros only.</p>
<h2 id="examples-m900">M900</h2>
<div class="admonition info">
<p class="admonition-title">Normal Macro</p>
</div>
<p>In Marlin, M900 K is used to set pressure/linear advance. Now, you can use it in Klipper too:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#examples-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#examples-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#examples-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#examples-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#examples-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#examples-__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[gcode_macro M900]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">description</span><span class="o">:</span><span class="w"> </span><span class="s">Set Pressure Advance</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="na">{% set k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.K|default(0)|float %}</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="na">{% if k &lt; 1 %}</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="na">SET_PRESSURE_ADVANCE ADVANCE</span><span class="o">=</span><span class="s">{k}</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="na">{% endif %}</span>
</code></pre></div></td></tr></table></div>
<h2 id="examples-recursion">Recursion</h2>
<div class="admonition success">
<p class="admonition-title">Dynamic Macro</p>
</div>
<p>These are a few example Dynamic Macros to demonstrate the recursive functionality of Dynamic Macros.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Counting to 10</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#examples-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#examples-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#examples-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#examples-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#examples-__codelineno-1-6">6</a></span>
<span class="normal"><a href="#examples-__codelineno-1-7">7</a></span>
<span class="normal"><a href="#examples-__codelineno-1-8">8</a></span>
<span class="normal"><a href="#examples-__codelineno-1-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[gcode_macro COUNT]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="na">{% set num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.NUM|default(1)|int %}</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="na">{% if num &lt;</span><span class="o">=</span><span class="w"> </span><span class="s">10 %}</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">{num}</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="na">COUNT NUM</span><span class="o">=</span><span class="s">{num+1}</span><span class="w"> </span><span class="c1"># Count up 1</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="na">{% else %}</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;Done Counting&quot;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="na">{% endif %}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Load to Filament Sensor</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#examples-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#examples-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#examples-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#examples-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#examples-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#examples-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#examples-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#examples-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#examples-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#examples-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#examples-__codelineno-2-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">[gcode_macro LOAD_TO_FSENSOR]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="na">{% set val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">printer[&quot;filament_sensor fsensor&quot;].filament_detected %}</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="na">{% if val</span><span class="w"> </span><span class="o">=</span><span class="s">= 0 %}</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">        </span><span class="na">M83</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">        </span><span class="na">G1 E50 F900 # Move filament 50mm forwards</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;Waiting for fsensor&quot;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">        </span><span class="na">LOAD_TO_FSENSOR # Recursion</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="na">{% else %}</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">        </span><span class="na">G1 E65 F900 # Move filament to nozzle</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">        </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;Filament Loaded&quot;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="na">{% endif %}</span>
</code></pre></div></td></tr></table></div>
<h2 id="examples-receiving-position-updates">Receiving Position Updates</h2>
<div class="admonition success">
<p class="admonition-title">Dynamic Macro</p>
</div>
<p>This is an example Dynamic Macro to demonstrate the ability to receive position updates from within the same macro.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#examples-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#examples-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#examples-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#examples-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#examples-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#examples-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#examples-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#examples-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#examples-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#examples-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#examples-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#examples-__codelineno-3-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">[gcode_macro DYNAMIC_MOVE]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">  </span><span class="na">G28</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">  </span><span class="na">M117 Before</span><span class="o">:</span><span class="w"> </span><span class="s">{printer.toolhead.position.z}</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">  </span><span class="c1"># Above displays position after G28</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span><span class="na">G90</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">  </span><span class="na">G1 Z20</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">  </span><span class="na">M117 After</span><span class="o">:</span><span class="w"> </span><span class="s">{printer.toolhead.position.z}</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">  </span><span class="c1"># Above displays position after G1</span>
</code></pre></div></td></tr></table></div>
<h2 id="examples-preserving-variables">Preserving Variables</h2>
<div class="admonition success">
<p class="admonition-title">Dynamic Macro</p>
</div>
<p>This is an example of how to preserve variables across triple-newlines in Dynamic Macros.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#examples-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#examples-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#examples-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#examples-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#examples-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#examples-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#examples-__codelineno-4-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">[gcode_macro VARIABLES]</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="na">{% set num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">update(&quot;num&quot;, 10) %}</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="na">M117 {num}</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="na">M117 {num}</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="c1"># Above line outputs 10</span>
</code></pre></div></td></tr></table></div>
<h2 id="examples-advanced-macros">Advanced Macros</h2>
<p>Thank you to <a href="https://klipper.discourse.group/u/mykepredko/summary">@mykepredko</a> on the <a href="https://klipper.discourse.group/">Klipper Discourse</a> for these macro ideas and for testing them.</p>
<h3 id="examples-query-adxl345-accelerometer">Query ADXL345 Accelerometer</h3>
<div class="admonition success">
<p class="admonition-title">Dynamic Macro</p>
</div>
<p>This macro reads the current acceleration values from an ADXL345 accelerometer.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#examples-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#examples-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#examples-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#examples-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#examples-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#examples-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#examples-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#examples-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#examples-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#examples-__codelineno-5-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">[gcode_macro READ_ADXL]</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">  </span><span class="na">{% set values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">python_file(&#39;read_adxl.py&#39;) %}</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="na">RESPOND TYPE</span><span class="o">=</span><span class="s">command MSG=&quot;Response={values}&quot;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="c1">#  {% if values == &quot;Python Error&quot; %}</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">  </span><span class="na">{% if values</span><span class="w"> </span><span class="o">=</span><span class="s">= &quot;No ADXL345&quot; %}</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">    </span><span class="na">RESPOND TYPE</span><span class="o">=</span><span class="s">command MSG=&quot;READ_ADXL: No ADXL345 Present&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="na">{% else %}</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="na">RESPOND TYPE</span><span class="o">=</span><span class="s">command MSG=&quot;READ_ADXL: ADXL345 Present&quot;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">    </span><span class="na">RESPOND TYPE</span><span class="o">=</span><span class="s">command MSG=&quot;READ_ADXL: x={values.x}, y={values.y}, z={values.z}&quot;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">  </span><span class="na">{% endif %}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">read_adxl.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#examples-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#examples-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#examples-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#examples-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#examples-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#examples-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#examples-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#examples-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#examples-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#examples-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#examples-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#examples-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#examples-__codelineno-6-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>  <span class="n">adxl</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;adxl345&#39;</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>  <span class="n">aclient</span> <span class="o">=</span> <span class="n">adxl</span><span class="o">.</span><span class="n">start_internal_client</span><span class="p">()</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>  <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;toolhead&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dwell</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>  <span class="n">aclient</span><span class="o">.</span><span class="n">finish_measurements</span><span class="p">()</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>  <span class="n">values</span> <span class="o">=</span> <span class="n">aclient</span><span class="o">.</span><span class="n">get_samples</span><span class="p">()</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>  <span class="n">_</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>  <span class="n">output</span><span class="p">({</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a>    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="n">y</span><span class="p">,</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="n">z</span><span class="p">,</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>  <span class="p">})</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="k">except</span><span class="p">:</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>  <span class="n">output</span><span class="p">(</span><span class="s2">&quot;No ADXL345&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="examples-query-bltouch">Query BLTouch</h3>
<div class="admonition success">
<p class="admonition-title">Dynamic Macro</p>
</div>
<p>This macro queries the status of a BLTouch sensor.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#examples-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#examples-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#examples-__codelineno-7-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">[gcode_macro QUERY_BLTOUCH]</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">  </span><span class="na">{% set values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">python_file(&#39;read_blt.py&#39;) %}</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">  </span><span class="na">RESPOND TYPE</span><span class="o">=</span><span class="s">command MSG=&quot;BLT Object={values}&quot;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">read_blt.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#examples-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#examples-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#examples-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#examples-__codelineno-8-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">blt</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;bltouch&#39;</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="n">toolhead</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;toolhead&#39;</span><span class="p">)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="n">print_time</span> <span class="o">=</span> <span class="n">toolhead</span><span class="o">.</span><span class="n">get_last_move_time</span><span class="p">()</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="n">status</span> <span class="o">=</span> <span class="n">blt</span><span class="o">.</span><span class="n">query_endstop</span><span class="p">(</span><span class="n">print_time</span><span class="p">)</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="n">output</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h3 id="examples-read-tmc-field">Read TMC field</h3>
<div class="admonition success">
<p class="admonition-title">Dynamic Macro</p>
</div>
<p>This macro reads the given field on the given TMC2209 driver, but can be adapted to use any TMC driver.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#examples-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#examples-__codelineno-9-3">3</a></span>
<span class="normal"><a href="#examples-__codelineno-9-4">4</a></span>
<span class="normal"><a href="#examples-__codelineno-9-5">5</a></span>
<span class="normal"><a href="#examples-__codelineno-9-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">[gcode_macro READ_TMC_FIELD]</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span><span class="na">{% set field_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.FIELD %}</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">  </span><span class="na">{% set stepper_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">params.STEPPER %}</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">  </span><span class="na">{% set value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">python_file(&#39;read_tmc_field.py&#39;, field=field_name, stepper=stepper_name) %}</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">  </span><span class="na">RESPOND MSG</span><span class="o">=</span><span class="s">&quot;\&quot;tmc2209 {stepper_name}-{field_name}\&quot; = {value}&quot;</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">read_tmc_field.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#examples-__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#examples-__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#examples-__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#examples-__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#examples-__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#examples-__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#examples-__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#examples-__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#examples-__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#examples-__codelineno-10-10">10</a></span>
<span class="normal"><a href="#examples-__codelineno-10-11">11</a></span>
<span class="normal"><a href="#examples-__codelineno-10-12">12</a></span>
<span class="normal"><a href="#examples-__codelineno-10-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">field</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">]</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="n">stepper</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;stepper&#39;</span><span class="p">]</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="n">tmc</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tmc2209 </span><span class="si">{</span><span class="n">stepper</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="n">register</span> <span class="o">=</span> <span class="n">tmc</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">field_to_register</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="c1"># Find register for given field</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="n">reg_val</span> <span class="o">=</span> <span class="n">tmc</span><span class="o">.</span><span class="n">mcu_tmc</span><span class="o">.</span><span class="n">get_register</span><span class="p">(</span><span class="n">register</span><span class="p">)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="k">if</span> <span class="n">reg_val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Queried register</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>  <span class="n">value</span> <span class="o">=</span> <span class="n">tmc</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">reg_name</span><span class="o">=</span><span class="n">register</span><span class="p">)</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="k">else</span><span class="p">:</span> <span class="c1"># Write-only register</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>  <span class="n">value</span> <span class="o">=</span> <span class="n">tmc</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">reg_value</span><span class="o">=</span><span class="n">reg_val</span><span class="p">,</span> <span class="n">reg_name</span><span class="o">=</span><span class="n">register</span><span class="p">)</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="n">output</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="devstatus"><h1 id="devstatus-development-status">Development Status</h1>
<h2 id="devstatus-features">Features</h2>
<ul>
<li>Editing macros without restarting Klipper</li>
<li>Accessing printer information from within Dynamic Macros</li>
<li>Accessing parameters from within Dynamic Macros</li>
<li>Adding new Dynamic Macros without restarting Klipper</li>
<li>Removing existing Dynamic Macros without restarting Klipper</li>
<li>Renaming Dynamic Macros without restarting Klipper</li>
<li>Dynamic Macro descriptions</li>
<li>Dynamic Macro variables</li>
<li>Retrieving variables from other macros</li>
<li>Support for <code>rename_existing</code></li>
<li>Running Python from within a Dynamic Macro</li>
<li>Dynamic <code>delayed_gcode</code> implementation</li>
<li>Traditional <code>delayed_gcode</code> syntax</li>
<li>Klippy extras tutorial</li>
<li>Logging for easier debugging</li>
<li>Configuring DynamicMacros clusters</li>
<li>Internal logging</li>
<li>Support for multiple Klipper instances</li>
<li>Rendering a Dynamic Macro without running it</li>
</ul>
<h2 id="devstatus-planned-features">Planned Features</h2>
<p>A checkmark indicates a feature is implemented and experimental.</p></section><h1 class='nav-section-title-end'>Ended: DynamicMacros</h1>
                        <h1 class='nav-section-title' id='section-klippy-extras'>
                            Klippy Extras <a class='headerlink' href='#section-klippy-extras' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="extras-extras-start"><h1 id="extras-extras-start-start-writing-klippy-extras">Start Writing Klippy Extras</h1>
<p>While DynamicMacros makes Klipper macros much more powerful, sometimes a Klippy extra is required for more functionality. In this tutorial, you will learn how to develop a Klippy extra and test it using DynamicMacros.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>To write a Klipper extra, you should be <strong>fluent</strong> in Python.</p>
</div>
<details class="info">
<summary>Klipper vs Klippy</summary>
<p>To limit confusion, I'm going to explain this here. "Klipper" is the name of the firmware running on your 3D printer. "Klippy" is the name of the software running on your Klipper Host (usually a Raspberry Pi). Klipper is written in C code, and Klippy is mostly written in Python.</p>
</details>
<p>Start writing your first Klippy extra:</p>
<p><a class="md-button" href="#extras-extras-intro">Introduction <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span></a></p></section><section class="print-page" id="extras-extras-intro"><h1 id="extras-extras-intro-introduction-to-writing-klippy-extras">Introduction to Writing Klippy Extras</h1>
<p>This page contains many things that are useful to know before writing Klippy extras.</p>
<h2 id="extras-extras-intro-klipper-vs-klippy">Klipper vs Klippy</h2>
<p>Klipper firmware is two parts. First, there's Klipper, which runs on the microcontroller. This is written in C. Then, there's Klippy which runs on the host (usually a Raspberry Pi), written in Python.</p>
<p>While both are fully open-source and modifiable to your needs, this tutorial will focus solely on Klippy, due to its easily expandable extras system.</p>
<h2 id="extras-extras-intro-how-extras-are-loaded">How extras are loaded</h2>
<p>When Klipper encounters a config section like the following:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">printer.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">[myextra]</span>
</code></pre></div></td></tr></table></div>
<p>It looks for a file in the extras directory named <code>myextra.py</code>. Then, it imports it as a Python module and runs the <code>load_config()</code> function (if present), passing in a <code>config</code> object, which returns another object later stored in the printer.</p>
<p>If the config has a name after the section like this:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">printer.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[myextra name]</span>
</code></pre></div></td></tr></table></div>
<p>It looks for a <code>load_config_prefix()</code> function instead.</p>
<h2 id="extras-extras-intro-the-config-object">The <code>config</code> object</h2>
<p>Every Klippy extra is a class. Everything in a Klippy extra starts when the class is initialized, passing a <code>config</code> object into the class. This <code>config</code> object allows access to many parts of Klipper discussed next.</p>
<h2 id="extras-extras-intro-the-printer-object">The <code>printer</code> object</h2>
<p>This is probably the most useful object you can use in a Klippy extra. This code block below shows how to get it:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>It's that simple!</p>
<p>The printer object lets you access all sorts of useful parts of Klippy, which will be explained later in this page.</p>
<h2 id="extras-extras-intro-the-gcode-object">The <code>gcode</code> object</h2>
<p>The next object you will want to get familiar with is the <code>gcode</code> object. This code block below shows how to get it:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">gcode</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>This <code>gcode</code> object is useful for many things. Here are a few of its functions:</p>
<ul>
<li><code>run_script_from_command</code> Runs any GCode provided as a string</li>
<li><code>respond_info</code> Displays text to the Klipper terminal; essentially the same as running <code>RESPOND MSG=</code> in a macro</li>
<li><code>register_command</code> Allows for defining custom GCode commands</li>
<li><code>register_mux_command</code> A different way to definine custom GCode commands. This is explained later in the examples.</li>
</ul>
<p>For example, if you wanted to run a <code>G28</code> command (home all axes), you would run:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">gcode</span><span class="o">.</span><span class="n">run_script_from_command</span><span class="p">(</span><span class="s1">&#39;G28&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<h2 id="extras-extras-intro-configuration-options">Configuration options</h2>
<p>The <code>config</code> object also allows reading of the configuration options present in the <code>printer.cfg</code> file. Here's an example config:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-5-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">[myextra]</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="na">integer</span><span class="o">:</span><span class="w"> </span><span class="s">5</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="na">float</span><span class="o">:</span><span class="w"> </span><span class="s">2.5</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="na">string</span><span class="o">:</span><span class="w"> </span><span class="s">hello</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="na">list</span><span class="o">:</span><span class="w"> </span><span class="s">3d,printing</span>
</code></pre></div></td></tr></table></div>
<p>This configuration shows four main option types:</p>
<ul>
<li><code>int</code></li>
<li><code>float</code></li>
<li><code>str</code></li>
<li><code>list</code></li>
</ul>
<p>To read them, you can use the corresponding functions of <code>config</code>:</p>
<ul>
<li><code>getint</code></li>
<li><code>getfloat</code></li>
<li><code>get</code></li>
<li><code>getlist</code></li>
</ul>
<p>Here's how to use them in code:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-6-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">number</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">decimal_number</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getfloat</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="n">text</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;string&#39;</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="n">my_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To make a configuration option optional, pass another parameter to the <code>get</code> function as a default value. Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">number</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;integer&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<h2 id="extras-extras-intro-where-do-klippy-extras-go">Where do Klippy Extras go?</h2>
<p>Before we go much further into this tutorial, it's good to know how Klippy reads the extras files. First, there's one last missing part of our Python file:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-8-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="k">return</span> <span class="n">MyExtra</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>This is explained later in the examples.</p>
<p>For Klippy to read your extras file, you need to put it in <code>~/klipper/klippy/extras</code>. The filename, in this case <code>myextra.py</code>, becomes the config name, in this case <code>[myextra]</code>. After putting your file in the <code>extras</code> folder, you can put a corresponding section into your <code>printer.cfg</code> and restart Klipper. Your extra is installed!</p>
<p>However, every time you want to change something, you have to copy your file to the extras folder and restart Klipper. This is a very slow way to develop extras, as each Klipper restart turns off your heaters, loses your home position, and wastes too much time.</p>
<p>Fortunately, DynamicMacros provides a better solution.</p>
<h2 id="extras-extras-intro-dynamicmacros">DynamicMacros</h2>
<p>Follow the installation instructions <a href="#setup">here</a>.</p>
<p>DynamicMacros supports running Python code from a macro. This makes testing parts of Klippy extras much quicker. Here's the current example, as a Klippy extra, excluding the config reading:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-9-3">3</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-9-4">4</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-9-5">5</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-9-6">6</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-9-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">class</span> <span class="nc">MyExtra</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>        <span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>        <span class="n">gcode</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>    <span class="k">return</span> <span class="n">MyExtra</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Here it is as a DynamicMacro (use the tabs to navigate between the two files):</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="extras-extras-intro-__tabbed_1_1" name="extras-extras-intro-__tabbed_1" type="radio" /><input id="extras-extras-intro-__tabbed_1_2" name="extras-extras-intro-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="extras-extras-intro-__tabbed_1_1">macros.cfg</label><label for="extras-extras-intro-__tabbed_1_2">myextra.py</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#extras-extras-intro-__codelineno-10-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">[gcode_macro myextra]</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="na">gcode</span><span class="o">:</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="na">{% _</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">python_file(&quot;myextra.py&quot;) %}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">printer_gcode</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>Now, you can change anything without restarting Klipper! Whenever you change the macro/Python code, simply run the <code>DYNAMIC_MACRO</code> command to internally refresh DynamicMacros.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This setup is intended for development, and not release, as this approach has a few limitations:</p>
<ul>
<li>This approach can't read configuration sections</li>
<li>This approach isn't as structured as a full Klippy extra</li>
</ul>
<p>For these reasons, this approach is only intended for testing parts of a Klippy extra, and isn't a replacement of extras.</p>
</div>
<p>This tutorial won't go in depth about testing extras with DynamicMacros. Instead, this tutorial focuses on writing traditional Klippy extras.</p>
<h2 id="extras-extras-intro-the-reactor-object">The <code>reactor</code> object</h2>
<p>Another useful object from the <code>config</code> object is the <code>reactor</code>. The code block below shows how to get it:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>The reactor opens up a new possibility of Klippy extras: scheduling code to run/repeat at any time. This ability is explained in more detail in the third example.</p>
<h2 id="extras-extras-intro-other-extras">Other Extras</h2>
<p>This is one more good-to-know about Klippy extras before continuing to the examples:</p>
<p>You can access other extras from an extra. This allows for extended capabilities of extras. For example, this project, DynamicMacros invokes the <code>gcode_macro</code> extra to run macros internally. The code blocks below shows two ways to access any other extra:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="extras-extras-intro-__tabbed_2_1" name="extras-extras-intro-__tabbed_2" type="radio" /><input id="extras-extras-intro-__tabbed_2_2" name="extras-extras-intro-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="extras-extras-intro-__tabbed_2_1">Method 1</label><label for="extras-extras-intro-__tabbed_2_2">Method 2</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-13-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="n">gcode_macro</span> <span class="o">=</span> <span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode_macro&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-intro-__codelineno-14-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">gcode_macro</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h2 id="extras-extras-intro-examples">Examples</h2>
<p>I hope this introduction was helpful. The next part of this tutorial consists of three examples. The first one is linked below:</p>
<p><a class="md-button" href="#extras-extras-ex1">Example 1: Greeter <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span></a></p></section><section class="print-page" id="extras-extras-ex1"><h1 id="extras-extras-ex1-example-1-greeter-structure">Example 1: Greeter (Structure)</h1>
<p>Before you start to write a Klippy extra, it is important to understand the structure of a Klippy extra. </p>
<hr />
<p>In Python, a Klippy extra is defined as a class, then referenced in a function at the end of the file. Example:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">greeter.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Greeter</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="o">...</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>    <span class="k">return</span> <span class="n">Greeter</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>There are two functions that can be used at the end of a file:</p>
<ul>
<li><code>load_config_prefix</code>, allows for configurations like <code>[greeter mygreeter]</code></li>
<li><code>load_config</code>, like in this example, allows for configurations like <code>[greeter]</code></li>
</ul>
<h2 id="extras-extras-ex1-initializer">Initializer</h2>
<p>In the last line of the above code block, you can see that a <code>config</code> object is passed as a parameter to the <code>Greeter</code> object. The initializer of the <code>Greeter</code> class is shown below in sections:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Get printer objects and configuration options</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>This section gets the <code>printer</code> object with <code class="highlight"><span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span></code>.</p>
<p>It then gets the <code>gcode</code> object with <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span></code>.</p>
<p>Then, it gets the <code>reactor</code> object with <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span></code>.</p>
<p>After that, it reads the configuration to get the <code>message</code> parameter, specifying <code class="highlight"><span class="s1">&#39;Welcome to Klipper!&#39;</span></code> as the default, using <code class="highlight"><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span></code>.</p>
<p>The next part of the initializer:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Register GCode command and event handler</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>            <span class="s1">&#39;GREET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET_help</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>The <code>self.gcode</code> object is used here to register the <code>GREET</code> command: </p>
<p><code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span><span class="s1">&#39;GREET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GRRET_help</span><span class="p">)</span></code></p>
<p>The <code>self.printer</code> object is then used to register an event handler to run when Klippy starts:</p>
<p><code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span><span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span></code></p>
<details class="info">
<summary>Event handlers</summary>
<p>Klipper supports the following event handlers for extras to use:</p>
<ul>
<li><code class="highlight"><span class="s2">&quot;klippy:ready&quot;</span></code></li>
<li><code class="highlight"><span class="s2">&quot;klippy:firmware_restart&quot;</span></code></li>
<li><code class="highlight"><span class="s2">&quot;klippy:disconnect&quot;</span></code></li>
</ul>
</details>
<p>The combined initializer is:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">greeter.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-3-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>            <span class="s1">&#39;GREET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET_help</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<h2 id="extras-extras-ex1-functions">Functions</h2>
<p>The next part of this Klippy extra is the class functions. This class has three functions aside from the initializer, two of which were mentioned in the <code>__init__</code> function:</p>
<ul>
<li><code>cmd_GREET</code></li>
<li><code>_ready_handler</code></li>
</ul>
<p>This example will start with the <code>_ready_handler</code> function:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">_ready_handler</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-4-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>    <span class="k">def</span> <span class="nf">_ready_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>This event handler sets a timer for one second after Klippy starts to run <code>_greet()</code>. <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span></code> represents the current time, and <code class="highlight"><span class="o">+</span> <span class="mi">1</span></code> adds one second. <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span></code> registers <code>_greet()</code> to run when <code>waketime</code> occurs.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">_greet()</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-5-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a>    <span class="k">def</span> <span class="nf">_greet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">NEVER</span>
</code></pre></div></td></tr></table></div>
<p>This function uses the <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span></code> object declared in the initializer. Here, the <code>respond_info</code> command is used (similar to running <code>RESPOND MSG=""</code>) to display <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">message</span></code>.</p>
<details class="info">
<summary>What is <code>eventtime</code>?</summary>
<p>You may have noticed that <code>eventtime</code> is passed to the <code>_greet()</code> function. This is because when Klippy runs <code>_greet()</code> from the previous <code>register_timer</code>, it passes <code>eventtime</code> as a parameter. This is useful if you want a function to repeat itself after a specified interval. In this case, we only want it to run once, so <code>eventtime</code> is unused.</p>
</details>
<details class="info">
<summary>The <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span></code> object</summary>
<p>The <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span></code> object has a few useful functions:</p>
<ul>
<li><code>register_command</code> (used in the initializer)</li>
<li><code>register_mux_command</code> (explained later)</li>
<li><code>respond_info</code> (used here)</li>
<li><code>run_script_from_command</code> (runs the provided string as GCode. The provided string can be multiple lines long)</li>
</ul>
</details>
<p>Finally, the <code>cmd_GREET</code> function:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">cmd_GREET</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-6-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a>    <span class="n">cmd_GREET_help</span> <span class="o">=</span> <span class="s2">&quot;Greet the user&quot;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span> <span class="nf">cmd_GREET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>Here, you can see the <code>cmd_GREET_help</code> is set to a string. Next, the <code>cmd_GREET</code> function takes in a <code>gcmd</code> parameter (unused). Finally, the <code>cmd_GREET</code> function calls <code>_greet()</code>.</p>
<details class="info">
<summary>The <code>gcmd</code> parameter</summary>
<p>The <code>gcmd</code> parameter allows functions to receive parameters. For example, if <code>GREET REPEAT=3</code> was called, the <code>REPEAT</code> parameter could be read as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-7-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">repeat</span> <span class="o">=</span> <span class="n">gcmd</span><span class="o">.</span><span class="n">get_int</span><span class="p">(</span><span class="s1">&#39;REPEAT&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>There are a few <code>get_</code> functions that can be used with the <code>gcmd</code> parameter:</p>
<ul>
<li><code>get</code> returns a <code class="highlight"><span class="nb">str</span></code></li>
<li><code>getint</code> returns an <code class="highlight"><span class="nb">int</span></code></li>
<li><code>getfloat</code> returns a <code class="highlight"><span class="nb">float</span></code></li>
</ul>
<p><code>gcmd</code> also has a <code>respond_info</code> function, similar to the <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span></code> function.</p>
<hr />
<p>The <code>repeat</code> variable can then be used:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex1-__codelineno-8-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">repeat</span><span class="p">):</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="extras-extras-ex1-install">Install</h2>
<p>To install a Klippy extra, it has to be placed in the <code>~/klipper/klippy/extras/</code> folder. Here's a simple command to install <code>greeter.py</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a>cp<span class="w"> </span>greeter.py<span class="w"> </span>~/klipper/klippy/extras/greeter.py
</code></pre></div></td></tr></table></div>
<p>You can also create an install script that uses the <code>ln</code> command to create a link to the file, rather than a copy:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">install.sh</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a>ln<span class="w"> </span>-f<span class="w"> </span>greeter.py<span class="w"> </span>~/klippy/klippy/extras/greeter.py
</code></pre></div></td></tr></table></div>
<h2 id="extras-extras-ex1-other-things">Other Things</h2>
<p>A few things that are good to know before moving on:</p>
<ul>
<li>If your Klippy extra uses <code>load_config_prefix</code>, instead of <code>load_config</code>, you can get the name of the configuration section (e.g. <code>[greeter first]</code> is named <code>first</code>) by using: 
    <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex1-__codelineno-11-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></td></tr></table></div></li>
<li>If you want to learn more about additional capabilities of Klippy extras, check out the <a href="https://github.com/Klipper3d/klipper/tree/master/klippy/extras">built-in Klippy extras</a>.</li>
<li>For further explanation of topics on this page, open the dropdowns.</li>
</ul>
<hr />
<p>Next example:</p>
<p><a class="md-button" href="#extras-extras-ex2">Example 2: BetterGreeter <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span></a></p></section><section class="print-page" id="extras-extras-ex2"><h1 id="extras-extras-ex2-example-2-bettergreeter">Example 2: BetterGreeter</h1>
<p>For this tutorial, we are going to improve on the greeter code used in <a href="#extras-extras-ex1">Structure</a>. </p>
<p>For reference, the entire original greeter code is below:</p>
<details open="open">
<summary>Original Greeter</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-0-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">class</span> <span class="nc">Greeter</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>            <span class="s1">&#39;GREET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET_help</span><span class="p">)</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>    <span class="k">def</span> <span class="nf">_ready_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="k">def</span> <span class="nf">_greet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">NEVER</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>    <span class="n">cmd_GREET_help</span> <span class="o">=</span> <span class="s2">&quot;Greet the user&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>    <span class="k">def</span> <span class="nf">cmd_GREET</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">()</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>    <span class="k">return</span> <span class="n">Greeter</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="extras-extras-ex2-goals">Goals</h2>
<p>For the <code>BetterGreeter</code>, we want the following features:</p>
<ul>
<li>Ability to have multiple different greetings</li>
<li>Allow the user to choose if they want their greeting to display after Klipper starts, and if so, to set the delay</li>
<li>Allow the user to set the message of the greeting</li>
</ul>
<p>Here's an example configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">better_greeter.cfg</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-1-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">[greeting welcome]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">message</span><span class="o">:</span><span class="w"> </span><span class="s">Welcome to Klipper!</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">delay</span><span class="o">:</span><span class="w"> </span><span class="s">1</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="k">[greeting gcode]</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="na">message</span><span class="o">:</span><span class="w"> </span><span class="s">Upload some GCode!</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="na">delay</span><span class="o">:</span><span class="w"> </span><span class="s">2</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="k">[greeting print_done]</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="na">message</span><span class="o">:</span><span class="w"> </span><span class="s">Print completed!</span>
</code></pre></div></td></tr></table></div>
<p>Here's the desired behavior (anything on the line of a <code>&gt;</code> is a user-typed command):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>&gt;<span class="w"> </span>RESTART
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>Welcome<span class="w"> </span>to<span class="w"> </span>Klipper!<span class="w"> </span><span class="c1"># (1)!</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>Upload<span class="w"> </span>some<span class="w"> </span>GCode!<span class="w"> </span><span class="c1"># (2)!</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>&gt;<span class="w"> </span>GREETING<span class="w"> </span><span class="nv">NAME</span><span class="o">=</span>print_done
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>Print<span class="w"> </span>completed!
</code></pre></div></td></tr></table></div>
<ol>
<li>One second after <code>RESTART</code></li>
<li>Two seconds after <code>RESTART</code></li>
</ol>
<h2 id="extras-extras-ex2-creating-the-base-class">Creating the Base Class</h2>
<p>The first step of creating a Klippy extra is to make the base class and the config function: </p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-3-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">class</span> <span class="nc">Greeting</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>        <span class="k">pass</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="c1"># (1)!</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="k">def</span> <span class="nf">load_config_prefix</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="k">return</span> <span class="n">Greeting</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li><code>load_config_prefix</code> is used here instead of <code>load_config</code> because there will be <strong>multiple</strong> <code>greeter</code> configuration sections.</li>
</ol>
<h2 id="extras-extras-ex2-reading-the-configuration">Reading the Configuration</h2>
<p>The next step of our Klippy extra is to setup the class variables and read the parameters:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-8">8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">class</span> <span class="nc">Greeting</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
</span><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
</span><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
</span><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="hll">
</span><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
</span><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<div class="admonition question inline end">
<p class="admonition-title">Quiz</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="extras-extras-ex2-__tabbed_1_1" name="extras-extras-ex2-__tabbed_1" type="radio" /><input id="extras-extras-ex2-__tabbed_1_2" name="extras-extras-ex2-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="extras-extras-ex2-__tabbed_1_1">Question</label><label for="extras-extras-ex2-__tabbed_1_2">Answer</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>If there was a configuration option (int) named <code>repeats</code>, how would you get it in the initializer?</p>
</div>
<div class="tabbed-block">
<p><code class="highlight"><span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;repeats&#39;</span><span class="p">)</span></code></p>
</div>
</div>
</div>
</div>
<p>Here, the <code>printer</code>, <code>reactor</code>, <code>gcode</code>, and <code>message</code> variables are the same as in the previous Klippy extra. However, in this case, there are a couple new variables:</p>
<ul>
<li><code>name</code> is explained in <a href="#extras-extras-ex1-other-things">the last section of Structure</a>.</li>
<li><code>delay</code> is read as an <code class="highlight"><span class="nb">int</span></code> from the <code>config</code> object, with default value <code class="highlight"><span class="mi">0</span></code>. The default value of <code class="highlight"><span class="mi">0</span></code> indicates it will not be run when Klippy starts.</li>
</ul>
<h2 id="extras-extras-ex2-gcode-commands-and-event-handler">GCode Commands and Event Handler</h2>
<p>After reading the configuration variables, we need to setup the GCode commands and event handler:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-5-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">class</span> <span class="nc">Greeting</span><span class="p">:</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="hll">        <span class="c1">#(1)!</span>
</span><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span>
</span><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="hll">            <span class="s1">&#39;GREETING&#39;</span><span class="p">,</span>
</span><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="hll">            <span class="s1">&#39;NAME&#39;</span><span class="p">,</span>
</span><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING</span><span class="p">,</span>
</span><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="hll">            <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING_help</span>
</span><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="hll">        <span class="p">)</span>
</span><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="hll">
</span><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="hll">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
</span><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="hll">            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li><code>register_mux_command</code> is used here because there are <strong>multiple</strong> <code>greeting</code> configuration sections, and each should be called separately.</li>
</ol>
<p>Here, a few parts are similar to the example in <a href="#extras-extras-ex1">Structure</a>, but not identical. Let's start with the GCode command.</p>
<p>In the Structure example, the GCode command was registered with:</p>
<p><code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span><span class="s1">&#39;GREET&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREET_help</span><span class="p">)</span></code></p>
<p>In this new example, the GCode command is registered with:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-6-6">6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-6-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="s1">&#39;GREETING&#39;</span><span class="p">,</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>    <span class="s1">&#39;NAME&#39;</span><span class="p">,</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING</span><span class="p">,</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>    <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING_help</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>The difference here is that there can be <strong>multiple</strong> <code>greeting</code> configuration sections, and as a result, multiple <code>Greeting</code> objects. To call each one separately, <code>register_mux_command</code> is used, passing the following parameters:</p>
<ul>
<li>Macro name: <code class="highlight"><span class="s2">&quot;GREETING&quot;</span></code></li>
<li>Parameter name: <code class="highlight"><span class="s2">&quot;NAME&quot;</span></code></li>
<li>Parameter value: <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">name</span></code></li>
<li>Function: <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING</span></code></li>
<li>Description <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING_help</span></code></li>
</ul>
<p>Next, the <code>register_event_handler</code> is nearly identical to the Structure example, except in this case, it is run only <code class="highlight"><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span></code>.</p>
<h2 id="extras-extras-ex2-functions">Functions</h2>
<p>The next part to creating this Klippy extra is the functions.</p>
<p>There are three functions in the <code>Greeting</code> class:</p>
<ul>
<li><code>ready_handler</code></li>
<li><code>_greet</code></li>
<li><code>cmd_GREETING</code></li>
</ul>
<details class="info">
<summary>Flowchart</summary>
<pre class="mermaid"><code>graph TD
A[klippy:ready] --&gt; B[_ready_handler]
    B --&gt; C[Wait self.delay seconds]
    C --&gt; D[_greet]
    D --&gt; E[Display self.message]
    F[cmd_GREETING] --&gt; E</code></pre>
</details>
<p>The first function, <code>_ready_handler</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">greeting.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-7-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span> <span class="nc">Greeting</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>            <span class="s1">&#39;GREETING&#39;</span><span class="p">,</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>            <span class="s1">&#39;NAME&#39;</span><span class="p">,</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING</span><span class="p">,</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>            <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING_help</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>        <span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="hll">    <span class="k">def</span> <span class="nf">_ready_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="hll">        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span>
</span><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>This function takes no parameters, and runs when Klippy reports <code class="highlight"><span class="s2">&quot;klippy:ready&quot;</span></code>.</p>
<p>Inside, the <code>waketime</code> variable is declared as <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span></code>. Let's break this declaration down:</p>
<ul>
<li><code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span></code> This is the current Klippy time</li>
<li><code class="highlight"><span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span></code> This adds <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">delay</span></code> to the current time.</li>
</ul>
<p>The result is that <code>waketime</code> contains the Klippy time for <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">delay</span></code> seconds in the future. Finally, we use <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span></code> to register this time, telling it to run <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">()</span></code> when the time occurs.</p>
<hr />
<p>The next function, <code>_greet</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">greeting.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-24">24</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-25">25</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-26">26</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-27">27</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-8-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">class</span> <span class="nc">Greeting</span><span class="p">:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>            <span class="s1">&#39;GREETING&#39;</span><span class="p">,</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>            <span class="s1">&#39;NAME&#39;</span><span class="p">,</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING</span><span class="p">,</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a>            <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING_help</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a>        <span class="p">)</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a>    <span class="k">def</span> <span class="nf">_ready_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="hll">    <span class="k">def</span> <span class="nf">_greet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
</span><a id="__codelineno-8-28" name="__codelineno-8-28"></a><span class="hll">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">NEVER</span>
</span></code></pre></div></td></tr></table></div>
<p class="annotate">This function takes an optional <code>eventtime</code> parameter (unused) (1), and prints out <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">message</span></code> to the Klipper console, using <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span></code>.</p>
<ol>
<li>This is passed by Klippy when it calls <code>_greet()</code> after the timer occurs.</li>
</ol>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you want the timer function to repeat, you can return the provided <code>eventtime</code> plus any number of seconds in the future, and it will repeat.</p>
</div>
<hr />
<p>The final function in this class is the <code>cmd_GREETING</code> function:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">greeting.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-25">25</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-29">29</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-30">30</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-31">31</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-9-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">class</span> <span class="nc">Greeting</span><span class="p">:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>            <span class="s1">&#39;GREETING&#39;</span><span class="p">,</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>            <span class="s1">&#39;NAME&#39;</span><span class="p">,</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING</span><span class="p">,</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>            <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING_help</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>        <span class="p">)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a>            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a>    <span class="k">def</span> <span class="nf">_ready_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a>    <span class="k">def</span> <span class="nf">_greet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">NEVER</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="hll">    <span class="n">cmd_GREETING_help</span> <span class="o">=</span> <span class="s2">&quot;Greet the user&quot;</span>
</span><a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="hll">    <span class="k">def</span> <span class="nf">cmd_GREETING</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
</span><a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>This function simply calls <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">()</span></code>, which displays <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">message</span></code> to the Klipper terminal.</p>
<h2 id="extras-extras-ex2-full-code">Full Code</h2>
<p>The full code of this Klippy extra is:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">greeting.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex2-__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-24">24</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-25">25</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-26">26</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-27">27</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-28">28</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-29">29</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-30">30</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-31">31</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-32">32</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-33">33</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-34">34</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-35">35</a></span>
<span class="normal"><a href="#extras-extras-ex2-__codelineno-10-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="k">class</span> <span class="nc">Greeting</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to Klipper!&#39;</span><span class="p">)</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>            <span class="s1">&#39;GREETING&#39;</span><span class="p">,</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a>            <span class="s1">&#39;NAME&#39;</span><span class="p">,</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING</span><span class="p">,</span>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a>            <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_GREETING_help</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a>        <span class="p">)</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a>            <span class="s1">&#39;klippy:ready&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ready_handler</span><span class="p">)</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a>    <span class="k">def</span> <span class="nf">_ready_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay</span>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a>    <span class="k">def</span> <span class="nf">_greet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">NEVER</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a>    <span class="n">cmd_GREETING_help</span> <span class="o">=</span> <span class="s2">&quot;Greet the user&quot;</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>    <span class="k">def</span> <span class="nf">cmd_GREETING</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_greet</span><span class="p">()</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="k">def</span> <span class="nf">load_config_prefix</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a>    <span class="k">return</span> <span class="n">Greeting</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>You can install it following <a href="#extras-extras-ex1-install">these</a> instructions, replacing <code>greeter.py</code> with <code>greeting.py</code>.</p>
<hr />
<p>Last example (so far):</p>
<p><a class="md-button" href="#extras-extras-ex3">Example 3: KlipperMaintenance <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span></a></p></section><section class="print-page" id="extras-extras-ex3"><h1 id="extras-extras-ex3-example-3-klippermaintenance">Example 3: KlipperMaintenance</h1>
<p>This last example of the Klippy extra development tutorial is actually one of my other Klipper projects: <a href="https://github.com/3DCoded/KlipperMaintenance">KlipperMaintenance</a>, a maintenance reminder system for Klipper.</p>
<p>This example will go through how the KlipperMaintenance code works to teach a few more important things about developing Klippy extras.</p>
<h2 id="extras-extras-ex3-full-code">Full Code</h2>
<p>For this tutorial, we'll start with the full code, then break it down and explain what each section does. If you can learn to read existing Klippy extras, you can read the <a href="https://github.com/Klipper3d/klipper/tree/master/klippy/extras">builtin Klippy extras</a> when developing your own extras.</p>
<details class="quote" open="open">
<summary>Full Code</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-0-1">  1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-2">  2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-3">  3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-4">  4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-5">  5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-6">  6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-7">  7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-8">  8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-9">  9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-100">100</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-101">101</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-102">102</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-103">103</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-104">104</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-105">105</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-106">106</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-107">107</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-108">108</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-109">109</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-110">110</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-111">111</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-112">112</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-113">113</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-114">114</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-115">115</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-116">116</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-117">117</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-118">118</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-119">119</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-120">120</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-121">121</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-122">122</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-123">123</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-124">124</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-125">125</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-126">126</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-127">127</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-128">128</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-129">129</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-130">130</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-131">131</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-132">132</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-133">133</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-134">134</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-135">135</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-136">136</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-137">137</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-138">138</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-139">139</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-140">140</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-141">141</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-142">142</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-143">143</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-144">144</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-145">145</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-146">146</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-147">147</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-148">148</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-149">149</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-150">150</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-151">151</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-0-152">152</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span> <span class="nn">urllib.request</span> <span class="k">as</span> <span class="nn">requests</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="n">API_URL</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:7125/server/history/totals&#39;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="n">HOME_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span><span class="s2">&quot;klippy:ready&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_ready</span><span class="p">)</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span><span class="s1">&#39;MAINTAIN_STATUS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS_help</span><span class="p">)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">def</span> <span class="nf">_handle_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gcode_timer_event</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a>    <span class="k">def</span> <span class="nf">_gcode_timer_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="p">):</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_maintenance</span><span class="p">()</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="n">nextwake</span> <span class="o">=</span> <span class="n">eventtime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="k">return</span> <span class="n">nextwake</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="k">def</span> <span class="nf">check_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>                <span class="k">continue</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">run_script_from_command</span><span class="p">(</span><span class="s1">&#39;M117 Maintenance Expired!&#39;</span><span class="p">)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">cmd_MAINTAIN_STATUS_help</span> <span class="o">=</span> <span class="s1">&#39;Check status of maintenance&#39;</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="k">def</span> <span class="nf">cmd_MAINTAIN_STATUS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="k">continue</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="n">remain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="k">if</span> <span class="n">remain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="n">obj</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1"> remaining&#39;</span><span class="p">)</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">(</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;print_time&#39;</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;print_time&#39;</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="c1"># register GCode commands</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;CHECK_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE_help</span><span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;UPDATE_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE_help</span><span class="p">)</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>    <span class="k">def</span> <span class="nf">fetch_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">API_URL</span><span class="p">)</span> <span class="c1"># fetch data from Moonraker History API</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>            <span class="p">}</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">job_totals</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;job_totals&#39;</span><span class="p">]</span> <span class="c1"># get job totals from JSON response</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_filament_used&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="p">}</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>    <span class="k">def</span> <span class="nf">fetch_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">def</span> <span class="nf">update_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">return</span> <span class="n">data</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">def</span> <span class="nf">get_remaining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>    <span class="n">cmd_CHECK_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Check maintenance&#39;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>    <span class="k">def</span> <span class="nf">cmd_CHECK_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>        <span class="n">gcmd</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a><span class="s1">Maintenance </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> Status:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a><span class="s1">Next maintenance in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="si">}</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="s1">Maintenance message: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>    <span class="n">cmd_UPDATE_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Update maintenance&#39;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>    <span class="k">def</span> <span class="nf">cmd_UPDATE_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">())</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">return</span> <span class="n">Maintenance</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="k">def</span> <span class="nf">load_config_prefix</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">return</span> <span class="n">Maintain</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
</details>
<h2 id="extras-extras-ex3-structure">Structure</h2>
<p>The class structure of this Klippy extra is shown in this flowchart:</p>
<pre class="mermaid"><code>classDiagram
    class Maintain{
        str name
        str label
        str trigger
        int threshold
        str message
        fetch_history()
        init_db()
        fetch_db()
        update_db(new)
        get_remaining()
        cmd_CHECK_MAINTENANCE(gcmd)
        cmd_UPDATE_MAINTENANCE(gcmd)
    }
    note for Maintain "trigger must be one of:\n - print_time\n - filament\n - time"

    class Maintenance{
        int interval
        _handle_ready()
        _gcode_timer_event()
        check_maintenance()
        cmd_MAINTAIN_STATUS(gcmd)
    }

    Maintenance &lt;|-- Maintain: Has-a</code></pre>
<p>This diagram has a lot of information, but the key points are:</p>
<ul>
<li>Multiple <code>Maintain</code> objects are managed by one <code>Maintainence</code> object.</li>
<li>The <code>Maintain</code> class handles maintenance reminders, the <code>CHECK_MAINTENANCE</code> command, and the <code>UPDATE_MAINTENANCE</code> command.</li>
<li>The <code>Maintenance</code> class handles the <code>MAINTAIN_STATUS</code> command.</li>
<li>A <code>[maintain name]</code> section corresponds to the <code>Maintain</code> class (multiple).</li>
<li>A <code>[maintain]</code> section corresponds to the <code>Maintenance</code> class (one).</li>
</ul>
<p>The base code for this is:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-1-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">import</span> <span class="nn">os</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span> <span class="nn">urllib.request</span> <span class="k">as</span> <span class="nn">requests</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="n">API_URL</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:7125/server/history/totals&#39;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="n">HOME_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="hll"><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
</span><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="hll">    <span class="k">pass</span>
</span><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="hll">
</span><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="hll"><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
</span><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="hll">    <span class="k">pass</span>
</span><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="hll">
</span><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="hll"><span class="c1"># (1)!</span>
</span><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="hll"><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
</span><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="hll">    <span class="k">return</span> <span class="n">Maintenance</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="hll">
</span><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="hll"><span class="c1"># (2)!</span>
</span><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="k">def</span> <span class="nf">load_config_prefix</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a>    <span class="k">return</span> <span class="n">Maintain</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>This function corresponds to a <code>[maintain]</code> config section.</li>
<li>This function corresponds to a <code>[maintain name]</code> config section.</li>
</ol>
<p>The highlighted section in the code contains the classes, and the configuration loading, the parts relevant to this first section. The code above the highlighted section includes the relevant module imports and constant declarations (both explained later).</p>
<p class="annotate">Much of the content in this example will be embedded in the code (usually the highlighted section) as a plus sign, like this: (1)</p>
<ol>
<li>Click some more plus marks in the code to learn more about the code.</li>
</ol>
<h2 id="extras-extras-ex3-maintain-class"><code>Maintain</code> class</h2>
<p>This next section of the example will focus on the <code>Maintain</code> class.</p>
<h3 id="extras-extras-ex3-initializer">Initializer</h3>
<p>When <code>load_config_prefix</code> creates a <code>Maintain</code> object, it starts in the initializer. </p>
<p>Here's the full initializer, with explanations embedded inside with plus signs. Below is a more general breakdown of the initializer for clarity.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-2-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
</span><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (1)!</span>
</span><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="hll">
</span><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="hll">        <span class="c1"># (2)!</span>
</span><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">(</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;print_time&#39;</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">])</span> 
</span><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="hll">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="c1"># (3)!</span>
</span><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
</span><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="hll">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span>
</span><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
</span><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="hll">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
</span><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="hll">            <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
</span><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="hll">
</span><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">)</span>
</span><a id="__codelineno-2-21" name="__codelineno-2-21"></a>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>        <span class="c1"># (4)!</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;CHECK_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_CHECK_MAINTENANCE_help</span><span class="p">)</span>
</span><a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_mux_command</span><span class="p">(</span><span class="s1">&#39;UPDATE_MAINTENANCE&#39;</span><span class="p">,</span> <span class="s1">&#39;NAME&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_UPDATE_MAINTENANCE_help</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li><code class="highlight"><span class="n">config</span><span class="o">.</span><span class="n">get_name</span><span class="p">()</span></code> returns the full config name, like <code class="highlight"><span class="s2">&quot;maintain name&quot;</span></code>. The <code class="highlight"><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span></code> splits the name by spaces and gets the last "word".</li>
<li><code class="highlight"><span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">()</span></code> allows you to only accept values in a certain list.</li>
<li>This part of the initializer chooses the units based on the <code>trigger</code> type:<ul>
<li><code class="highlight"><span class="s2">&quot;print_time&quot;</span></code>: <code class="highlight"><span class="s2">&quot;h&quot;</span></code></li>
<li><code class="highlight"><span class="s2">&quot;filament&quot;</span></code>: <code class="highlight"><span class="s2">&quot;m&quot;</span></code></li>
<li><code class="highlight"><span class="s2">&quot;time&quot;</span></code>: <code class="highlight"><span class="s2">&quot;h&quot;</span></code></li>
</ul>
</li>
<li>This is explained later, in functions.</li>
</ol>
<p>The major breakdown of this initializer is:</p>
<ul>
<li><strong>First highlighted section:</strong> Load basic objects</li>
<li><strong>Second highlighted section:</strong> Read configuration options</li>
<li><strong>Third highlighted section:</strong> Register GCode commands</li>
</ul>
<p>The line <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">init_db</span><span class="p">()</span></code> will be explained later in functions.</p>
<div class="admonition question">
<p class="admonition-title">Quiz</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="extras-extras-ex3-__tabbed_1_1" name="extras-extras-ex3-__tabbed_1" type="radio" /><input id="extras-extras-ex3-__tabbed_1_2" name="extras-extras-ex3-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="extras-extras-ex3-__tabbed_1_1">Question</label><label for="extras-extras-ex3-__tabbed_1_2">Answer</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>How would you add another trigger type (called <code class="highlight"><span class="s2">&quot;axes_distance&quot;</span></code> with units <code class="highlight"><span class="s2">&quot;m&quot;</span></code>)?</p>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-3-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getchoice</span><span class="p">(</span><span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="p">[</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span class="s1">&#39;print_time&#39;</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>    <span class="s1">&#39;filament&#39;</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>    <span class="s1">&#39;time&#39;</span><span class="p">,</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="hll">    <span class="s1">&#39;axes_distance&#39;</span><span class="p">])</span>
</span><a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="c1"># (3)!</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;h&#39;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="hll"><span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span> <span class="o">==</span> <span class="s1">&#39;axes_distance&#39;</span><span class="p">:</span>
</span><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="hll">    <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;m&#39;</span>
</span></code></pre></div></td></tr></table></div>
</div>
</div>
</div>
</div>
<h3 id="extras-extras-ex3-functions">Functions</h3>
<p>The next part of the <code>Maintain</code> class is its functions. The functions in this class are, broken down into two sections:</p>
<p><strong>Database:</strong></p>
<ul>
<li><code>fetch_history()</code></li>
<li><code>init_db()</code></li>
<li><code>fetch_db()</code></li>
<li><code>update_db(new)</code></li>
</ul>
<p><strong>GCode:</strong></p>
<ul>
<li><code>get_remaining()</code></li>
<li><code>cmd_CHECK_MAINTENANCE(gcmd)</code></li>
<li><code>cmd_UPDATE_MAINTENANCE(gcmd)</code></li>
</ul>
<p>First, the database functions (again, plus signs throughout the code explain in more detail what each part does):</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-31">31</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-32">32</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-33">33</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-34">34</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-35">35</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-36">36</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-37">37</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-38">38</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-39">39</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-40">40</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-41">41</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-42">42</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-43">43</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-44">44</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-45">45</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-46">46</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-47">47</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-4-48">48</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span class="o">...</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>    <span class="k">def</span> <span class="nf">fetch_history</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>        <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">API_URL</span><span class="p">)</span> <span class="c1"># fetch data from Moonraker History API</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> 
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data </span><span class="si">{</span><span class="n">resp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>            <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>                <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a>                <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>            <span class="p">}</span> <span class="c1"># (1)!</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>        <span class="n">job_totals</span> <span class="o">=</span> <span class="n">json_data</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">][</span><span class="s1">&#39;job_totals&#39;</span><span class="p">]</span> <span class="c1"># get job totals from JSON response</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a>            <span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_time&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span><span class="p">,</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a>            <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="n">job_totals</span><span class="p">[</span><span class="s1">&#39;total_filament_used&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>            <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>        <span class="p">}</span> <span class="c1"># (2)!</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a>    <span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a>        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()</span> <span class="c1"># Load the database</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a>        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a>            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># Update the database with history data</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a>    <span class="k">def</span> <span class="nf">fetch_db</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># (3)!</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># JSON parse the file contents</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a>                <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a>                    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>                <span class="k">return</span> <span class="n">data</span> <span class="c1"># Return parsed data</span>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a>    <span class="k">def</span> <span class="nf">update_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new</span><span class="p">):</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">HOME_DIR</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;maintain-db/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1"># (3)!</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a>        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># (4)!</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span> <span class="c1"># The &quot;w+&quot; file operator allows reading and writing</span>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a>                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="c1"># JSON parse the file contents</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a>            <span class="k">except</span><span class="p">:</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a>                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;print_time&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;filament&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">/</span><span class="mi">3600</span><span class="p">}</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>            <span class="n">data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new</span><span class="p">)</span> <span class="c1"># Update the file contents with the new data</span>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a>            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="c1"># JSON write the new data to the file</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a>        <span class="k">return</span> <span class="n">data</span> <span class="c1"># Return the new updated data</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>In case of an error, empty placeholder data is returned.</li>
<li>If history fetch was successful, return the data read from the Moonraker History API.</li>
<li>The <code>path</code> is (if the username is <code>pi</code> and <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">name</span></code> is <code class="highlight"><span class="s2">&quot;lubricate&quot;</span></code>) <code class="highlight"><span class="s2">&quot;/home/pi/maintain-db/lubricate&quot;</span></code>. Even though it has no file extension, it stores JSON data.</li>
<li>The first time running this, the <code>maintain-db</code> folder won't exist. <code>os.makedirs</code> creates the folder, and <code class="highlight"><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span></code> doesn't throw an error if it already exists.</li>
</ol>
<p>The flow of information in this Klippy extra is:</p>
<ul>
<li><code>init_db()</code> is called when Klippy starts</li>
<li><code>fetch_db()</code> is called to read the stored database</li>
<li>If the data returned by <code>fetch_db()</code> is <code>None</code> (database is empty)<ul>
<li><code>fetch_history()</code> is called to fetch the history stored by Moonraker</li>
<li><code>update_db()</code> is called to update the database with the newly fetched data.</li>
</ul>
</li>
</ul>
<p>Calling <code>update_db()</code> will erase the current maintenance state (resetting the timer/filament counter).</p>
<hr />
<p>The next section of functions in the <code>Maintain</code> class are the GCode commands. There are three functions in this section:</p>
<ul>
<li><code>get_remaining()</code></li>
<li><code>cmd_CHECK_MAINTENANCE(gcmd)</code></li>
<li><code>cmd_UPDATE_MAINTENANCE(gcmd)</code></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-5-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">class</span> <span class="nc">Maintain</span><span class="p">:</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span class="o">...</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>    <span class="k">def</span> <span class="nf">get_remaining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1"># Returns the remaining hours/meters until this expires</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_db</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span> <span class="c1"># Get the last trigger</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a>        <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()[</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">]</span> <span class="c1"># Get the current state</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>        <span class="k">return</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">-</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Return how close the difference is to self.threshold, and round to two decimal places</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>    <span class="n">cmd_CHECK_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Check maintenance&#39;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a>    <span class="k">def</span> <span class="nf">cmd_CHECK_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>        <span class="n">gcmd</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="s1">Maintenance </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1"> Status:</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="s1">Next maintenance in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="si">}</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="s1">Maintenance message: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="s1">        &#39;&#39;&#39;</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>    <span class="n">cmd_UPDATE_MAINTENANCE_help</span> <span class="o">=</span> <span class="s1">&#39;Update maintenance&#39;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a>    <span class="k">def</span> <span class="nf">cmd_UPDATE_MAINTENANCE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">())</span> <span class="c1"># (1)!</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>This erases the current maintenance status, and is called when maintenance has been done. <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">fetch_history</span><span class="p">()</span></code> retrieves the current state of the printer history (print time, filament), and then <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">update_db</span><span class="p">()</span></code> saves that data to the JSON database.</li>
</ol>
<p>The first function, <code>get_remaining</code>, works as follows (assuming the trigger is <code>print_time</code> and threshold is <code>250</code>):</p>
<ol>
<li>Read the last print time that maintenance occured at</li>
<li>Read the current accumulated print time</li>
<li>Get the difference between the two (how long has it been since last maintenance?)</li>
<li>Subtract that from <code>threshold</code> (how much longer until maintenance should be done?)</li>
<li>Round to two decimal places and return</li>
</ol>
<p>The next function, <code>cmd_CHECK_MAINTENANCE</code>, corresponds to the GCode command <code>CHECK_MAINTENANCE</code>, and outputs the <code>Maintain</code> object's variables in a user-friendly format.</p>
<p>The final function, <code>cmd_UPDATE_MAINTENANCE</code>, corresponds to the GCode command <code>UPDATE_MAINTENANCE</code>, and erases the current maintenance state. Click the plus sign in the function for more information.</p>
<h2 id="extras-extras-ex3-maintenance-class">Maintenance Class</h2>
<p>Now that we've gone through the <code>Maintain</code> class, let's see how multiple <code>Maintain</code> objects are managed in the <code>Maintenance</code> class. This class does the following:</p>
<ul>
<li>Displays maintenance reminders</li>
<li>Provides the <code>MAINTAIN_STATUS</code> command to overview the current maintenance state</li>
</ul>
<p>Unlike the <code>Maintain</code> class, which has multiple objects, there will be only one <code>Maintenance</code> object. Let's start with the initializer.</p>
<h3 id="extras-extras-ex3-initializer_1">Initializer</h3>
<p>The initializer of the <code>Maintenance</code> class is shown below:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintain.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-6-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_printer</span><span class="p">()</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">get_reactor</span><span class="p">()</span>
</span><a id="__codelineno-6-6" name="__codelineno-6-6"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_object</span><span class="p">(</span><span class="s1">&#39;gcode&#39;</span><span class="p">)</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getint</span><span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
</span><a id="__codelineno-6-9" name="__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="kc">None</span>
</span><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
</span><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">register_event_handler</span><span class="p">(</span><span class="s2">&quot;klippy:ready&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_ready</span><span class="p">)</span>
</span><a id="__codelineno-6-13" name="__codelineno-6-13"></a>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">register_command</span><span class="p">(</span><span class="s1">&#39;MAINTAIN_STATUS&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cmd_MAINTAIN_STATUS_help</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>This initializer may look similar to the BetterGreeter initializer in the previous example. This is because both the <code>BetterGreeter</code> and <code>Maintenance</code> classes use Klipper's timer system to schedule events. </p>
<p>There are four highlighted sections in the above code block. Let's go through each of them and explain what they do. </p>
<ol>
<li>This sets up the <code>reactor</code> object, which is important in scheduling events with Klipper.</li>
<li>This reads the interval from the configuration, defaulting to <code class="highlight"><span class="mi">60</span></code> if no value is provided.</li>
<li>This section is based off the <code>delayed_gcode</code> code, which is builtin to Klipper. Source code <a href="https://github.com/Klipper3d/klipper/blob/12cd1d9e81c32b26ccc319af1dfc3633438908f1/klippy/extras/delayed_gcode.py">here</a>. This section declares a <code>timer_handler</code>, <code>inside_timer</code>, and <code>repeat</code> variables, all of which will be used later. The last line of this section registers the <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">_handle_ready</span></code> function to run when Klippy is ready.</li>
<li>This final line registers the <code class="highlight"><span class="s2">&quot;MAINTAIN_STATUS&quot;</span></code> GCode command.</li>
</ol>
<h3 id="extras-extras-ex3-functions_1">Functions</h3>
<p>The next part of the <code>Maintenance</code> class is its functions:</p>
<ul>
<li><code>_handle_ready</code></li>
<li><code>_gcode_timer_event</code></li>
<li><code>check_maintenance</code></li>
<li><code>cmd_MAINTAIN_STATUS</code></li>
</ul>
<p>Click on the plus symbols in the code below to learn more about specific parts.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">maintian.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#extras-extras-ex3-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-22">22</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-23">23</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-24">24</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-25">25</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-26">26</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-27">27</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-28">28</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-29">29</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-30">30</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-31">31</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-32">32</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-33">33</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-34">34</a></span>
<span class="normal"><a href="#extras-extras-ex3-__codelineno-7-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">class</span> <span class="nc">Maintenance</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span class="k">def</span> <span class="nf">_handle_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>        <span class="n">waketime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="c1"># (1)!</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">timer_handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">register_timer</span><span class="p">(</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_gcode_timer_event</span><span class="p">,</span> <span class="n">waketime</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a>    <span class="k">def</span> <span class="nf">_gcode_timer_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eventtime</span><span class="p">):</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a>        <span class="c1"># This function is based on the delayed_gcode Klipper code.</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">check_maintenance</span><span class="p">()</span> <span class="c1"># Check if maintenance needs to be done.</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>        <span class="n">nextwake</span> <span class="o">=</span> <span class="n">eventtime</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">interval</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inside_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>        <span class="k">return</span> <span class="n">nextwake</span> <span class="c1"># (2)!</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>    <span class="k">def</span> <span class="nf">check_maintenance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (3)!</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span> <span class="c1"># (4)!</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a>                <span class="k">continue</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># (5)!</span>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">run_script_from_command</span><span class="p">(</span><span class="s1">&#39;M117 Maintenance Expired!&#39;</span><span class="p">)</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a>    <span class="n">cmd_MAINTAIN_STATUS_help</span> <span class="o">=</span> <span class="s1">&#39;Check status of maintenance&#39;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a>    <span class="k">def</span> <span class="nf">cmd_MAINTAIN_STATUS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gcmd</span><span class="p">):</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a>        <span class="n">objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span><span class="p">(</span><span class="s1">&#39;maintain&#39;</span><span class="p">)</span> <span class="c1"># Load all Maintain objects</span>
<a id="__codelineno-7-28" name="__codelineno-7-28"></a>        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a>            <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># (3)!</span>
<a id="__codelineno-7-30" name="__codelineno-7-30"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Maintain</span><span class="p">):</span> <span class="c1"># (4)!</span>
<a id="__codelineno-7-31" name="__codelineno-7-31"></a>                <span class="k">continue</span>
<a id="__codelineno-7-32" name="__codelineno-7-32"></a>            <span class="n">remain</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span> <span class="c1"># You can call functions on other Klippy extras</span>
<a id="__codelineno-7-33" name="__codelineno-7-33"></a>            <span class="k">if</span> <span class="n">remain</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># (5)!</span>
<a id="__codelineno-7-34" name="__codelineno-7-34"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Maintenance &quot;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot; Expired!</span><span class="se">\n</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<a id="__codelineno-7-35" name="__codelineno-7-35"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">gcode</span><span class="o">.</span><span class="n">respond_info</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">get_remaining</span><span class="p">()</span><span class="si">}{</span><span class="n">obj</span><span class="o">.</span><span class="n">units</span><span class="si">}</span><span class="s1"> remaining&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<div class="admonition question">
<p class="admonition-title">Quiz</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="extras-extras-ex3-__tabbed_2_1" name="extras-extras-ex3-__tabbed_2" type="radio" /><input id="extras-extras-ex3-__tabbed_2_2" name="extras-extras-ex3-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="extras-extras-ex3-__tabbed_2_1">Question</label><label for="extras-extras-ex3-__tabbed_2_2">Answer</label></div>
<div class="tabbed-content">
<div class="tabbed-block">What does <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span></code> return?</div>
<div class="tabbed-block"><code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span></code> returns the current Klippy time.</div>
</div>
</div>
</div>
</li>
<li>This is necessary for the timer to repeat. If you wanted to make this function not repeat, you can make it return <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">reactor</span><span class="o">.</span><span class="n">NEVER</span></code>.</li>
<li>Whenever you use <code class="highlight"><span class="n">printer</span><span class="o">.</span><span class="n">lookup_objects</span></code>, it will return a list of tuples, where each tuple contains, in order, the configuration name of the object, then the actual Python object.</li>
<li>Because the <code>Maintenance</code> class is also configured with a <code>[maintain]</code> config section (the difference being that <code>Maintenance</code> doesn't have a name, while <code>Maintain</code> does have a name, like <code>[maintain lubricate]</code>), a check has to be made to ensure a <code>Maintain</code> object has been found.</li>
<li><code class="highlight"><span class="k">if</span> <span class="n">get_remaining</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span></code>, the maintenance is expired and needs to be done.</li>
</ol>
<p>There are general flows of information in these functions:</p>
<p><strong>GCode Flow:</strong></p>
<ol>
<li><code>MAINTAIN_STATUS</code> is called from GCode</li>
<li><code>cmd_MAINTAIN_STATUS</code> is called in Python</li>
<li>All <code>Maintain</code> objects are retrieved</li>
<li>If a <code>Maintain</code> object is expired, notify the user in the terminal</li>
<li>Display the status of all <code>Maintain</code> objects</li>
</ol>
<p><strong>Timer Flow:</strong></p>
<ol>
<li>Klippy reports ready and calls <code>_handle_ready</code></li>
<li><code>_handle_ready</code> schedules an event to happen in <code class="highlight"><span class="bp">self</span><span class="o">.</span><span class="n">interval</span></code> seconds</li>
<li><code>_gcode_timer_event</code> is called by Klippy, and the maintenance is checked</li>
<li>Repeat step 3 until Klippy shuts down</li>
</ol>
<p>The first flow, the GCode flow, runs when the user manually runs the <code>MAINTAIN_STATUS</code> command. This makes it useful for checking how close certain maintenance objects are to being expired.</p>
<p>The second flow, the timer flow, runs behind the scenes as long as Klippy is running. This makes it useful for reminding the user if maintenance needs to be done without the need for manually checking.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Using a combination of GCode-initiated code, and timer-initiated code allows for Klippy extras to be more user-friendly.</p>
</div>
<h2 id="extras-extras-ex3-feedback">Feedback</h2>
<p>Was this tutorial helpful? Do you have any feedback for it? Are there any areas where you think this could be improved?</p>
<p>Let me know either on the <a href="https://klipper.discourse.group/t/klippy-extras-tutorial/18184?u=3dcoded">Klipper Discourse</a> or in a <a href="https://github.com/3DCoded/DynamicMacros/issues/new?assignees=3dcoded&amp;labels=documentation&amp;projects=&amp;template=docs.yml&amp;title=%5BDOCS%5D%3A+">Documentation Issue</a> on Github.</p>
<p>Thank you for your feedback!</p></section><h1 class='nav-section-title-end'>Ended: Klippy Extras</h1></div>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! Help us improve this page by <a href="https://github.com/3DCoded/DynamicMacros/issues/new?assignees=&labels=documentation&projects=&template=documentation.md&title=%5BDOCS%5D" target="_blank" rel="noopener">opening an issue</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://3dcoded.github.io" target="_blank" rel="noopener" title="3dcoded.github.io" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "/", "features": ["navigation.tabs", "content.action.edit", "navigation.expand", "navigation.instant", "navigation.instant.prefetch", "navigation.footer", "content.code.copy", "content.code.annotate", "search.suggest", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>